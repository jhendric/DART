<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<HTML>
<TITLE>module xxxxxxx</TITLE>
<link rel=stylesheet type=text/css href=doc.css>
<BODY>

<DIV ALIGN=CENTER>
<A HREF="#Interface">INTERFACE</A> / 
<A HREF="#PublicEntities">PUBLIC COMPONENTS</A> / 
<A HREF="#Namelist">NAMELIST</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A> /
<A HREF="#PrivateComponents">PRIVATE COMPONENTS</A>
</DIV>

<!--==================================================================-->

<H1>MODULE assim_tools_mod</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
   <TR><TD>Contact:       </TD><TD> Jeff Anderson                </TD></TR>
   <TR><TD>Reviewers:     </TD><TD> &nbsp;                       </TD></TR>
   <TR><TD>Revision:      </TD><TD> $Revision$             </TD></TR>
   <TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
   <TR><TD>Change history:</TD><TD> see CVS log                  </TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>
This module provides subroutines that implement the sequential scalar
filter algorithms. These include the standard sequential filter as 
described in Anderson (2003) along with systematic correction algorithms
for both mean and spread. In addition, algorithms to do a variety of 
flavors of filters including the EAKF, ENKF, particle filter, and kernel
filters are included.
<P>
   
</P>

<!--==================================================================-->

<A NAME="OTHER MODULES USED"></A>
<BR><HR><BR>
<H2>OTHER MODULES USED</H2>
<PRE>
types_mod
utilities_mod
sort_mod
random_seq_mod
</PRE>

<!--==================================================================-->
<!--Note to authors. The first row of the table is different.         -->

<A NAME="Interface"></A>
<BR><HR><BR>
<H2>PUBLIC INTERFACE</H2>

<TABLE>
<TR><TD><em class=call>use assim_tools_mod, only : </em></TD>
                   <TD><A HREF="#yyyroutine1">assim_tools_init</A> &</TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#yyyroutine2">obs_increment</A> &</TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#yyyroutine3">update_from_obs_inc</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#yyyroutine4">look_for_bias</A></TD></TR>
</TABLE>

</P>

<!--==================================================================-->
<!-- Declare all public entities ...                                  -->
<!-- duplicate public routines template as many times as necessary    -->
<!-- make sure you replace all yyyroutine?? strings                   -->
<!--==================================================================-->

<A NAME="PublicEntities"></A>
<BR><HR><BR>
<H2>PUBLIC COMPONENTS</H2>
</P>


<!--===================== DESCRIPTION OF SUBROUTINE =====================-->

<A NAME="yyyroutine1"></A>
<P></P><HR><P></P>
<div class=routine>
<em class=call>call assim_tools_init(  )</em>
<pre>
</pre></div>

<H3 class=indent1>Description</H3>

<P>
   Initialization routine for assim_tools. This must be called before other 
   public interfaces can be used.   
</P>
</P>


<!--===================== DESCRIPTION OF SUBROUTINE =====================-->

<A NAME="yyyroutine2"></A>
<P></P><HR><P></P>
<div class=routine>
<em class=call> call obs_increment( ens, ens_size, obs, obs_var, obs_inc, slope, a, 
               <em class=optionalcode>[,bias_ratio_out]</em> )</em>
<pre>
real(r8), intent(in), dimension(ens_size) :: <em class=code>ens </em>
integer, intent(in)                       :: <em class=code>ens_size </em>
real(r8), intent(in)                      :: <em class=code> obs </em>
real(r8), intent(in)                      :: <em class=code> obs_var </em>
real(r8), intent(out), dimension(ens_size) :: <em class=code> obs_inc </em>
real(r8), intent(in)                      :: <em class=code> slope </em>
real(r8), intent(out)                      :: <em class=code> a </em>
real(r8), OPTIONAL, intent(out)           :: <em class=optionalcode> bias_ratio_out </em>
</pre></div>

<H3 class=indent1>Description</H3>

<P>
   Does a scalar update of a prior ensemble in observation space and computes
   the increments for each prior ensemble member. Four different ensemble filter
   algorithms are selectable through a namelist arguement. The EAKF variant also
   includes a capability to do an empirical systematic error correction. 
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>

<TR><TD valign=top><em class=code>ens &nbsp; &nbsp; </em></TD>
    <TD>The prior ensemble expected values for this observation.</TD></TR>

<TR><TD valign=top><em class=code>ens_size</em></TD>
    <TD>Size of the prior ensemble.</TD></TR>

<TR><TD valign=top><em class=code>obs</em></TD>
    <TD>The observed value (from the instrument).</TD></TR>

<TR><TD valign=top><em class=code>obs_var</em></TD>
    <TD>The observational error variance (from the observing system).</TD></TR>

<TR><TD valign=top><em class=code>obs_inc</em></TD>
    <TD>The increments computed for the prior ensemble.</TD></TR>

<TR><TD valign=top><em class=code>slope</em></TD>
    <TD> Parameter that controls the strength of the systematic error correction.
         Values range from small positive (strong corrections) to 1.0 (weak
         corrections). A value of 0 indicates that no correction is to be done.</TD></TR>

<TR><TD valign=top><em class=code>a</em></TD>
    <TD>Ratio of updated ensemble standard deviation to prior standard deviation from EAKF.
        This is used in the heuristic prior variance reduction correction in 
        update_from_obs_inc.</TD></TR>

<TR><TD valign=top><em class=optionalcode>bias_ratio_out</em></TD>
    <TD>Optional ratio of difference between ensemble mean and observation
        and expected value. Can be used to assess systematic error.</TD></TR>

</TABLE>

</P>


<!--===================== DESCRIPTION OF SUBROUTINE =====================-->

<A NAME="yyyroutine3"></A>
<P></P><HR><P></P>
<div class=routine>
<em class=call> call update_from_obs_inc(obs, obs_inc, state, ens_size, a,
   state_inc, reg_coef,
               <em class=optionalcode>[,correl_out]</em> )</em>
<pre>
real(r8), intent(in), dimension(ens_size)  :: <em class=code>obs </em>
real(r8), intent(in), dimension(ens_size)  :: <em class=code>obs_inc </em>
real(r8), intent(in), dimension(ens_size)  :: <em class=code>state </em>
integer, intent(in)                        :: <em class=code>ens_size </em>
real(r8), intent(in)                       :: <em class=code> a </em>
real(r8), intent(out), dimension(ens_size) :: <em class=code>state_inc </em>
real(r8), intent(out)                      :: <em class=code> reg_coef </em>
real(r8), OPTIONAL, intent(out)            :: <em class=optionalcode> correl_out </em>
</pre></div>

<H3 class=indent1>Description</H3>

<P>
   Given the prior joint distribution of an observation and a state variable
   along with computed increments for the observation ensemble members, uses
   a linear regression to compute increments for the state variable ensemble.
   An optional algorithm to do prior corrections of spread reduction is also
   available for use with the EAKF variant of the filter. The increments and the
   regression coefficient are returned and optionally the correlation between
   the state and observation priors.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>

<TR><TD valign=top><em class=code>obs &nbsp; &nbsp; </em></TD>
    <TD>The prior ensemble expected values for this observation.</TD></TR>

<TR><TD valign=top><em class=code>obs_inc &nbsp; &nbsp; </em></TD>
    <TD>The observation increments for the ensemble computed by
        obs_increment.</TD></TR>

<TR><TD valign=top><em class=code>state &nbsp; &nbsp; </em></TD>
    <TD>The prior ensemble values for a state variable.</TD></TR>

<TR><TD valign=top><em class=code>ens_size</em></TD>
    <TD>Size of the ensemble.</TD></TR>

<TR><TD valign=top><em class=code>a</em></TD>
    <TD>Ratio of updated ensemble standard deviation to prior standard deviation from EAKF.
        This is used in the heuristic prior variance reduction correction in 
        update_from_obs_inc.</TD></TR>

<TR><TD valign=top><em class=code>state_inc</em></TD>
    <TD>The increments computed for the state variable ensemble.</TD></TR>

<TR><TD valign=top><em class=code>reg_coef</em></TD>
    <TD> The regression coefficient between the observation and state variable
         ensembles.</TD></TR>

<TR><TD valign=top><em class=optionalcode>correl_out</em></TD>
    <TD>Optional sample correlation between state and prior.</TD></TR>

</TABLE>

</P>


<!--===================== DESCRIPTION OF SUBROUTINE =====================-->

<A NAME="yyyroutine4"></A>
<P></P><HR><P></P>
<div class=routine>
<em class=call> call look_for_bias(ens, n, obs, obs_var, var_ratio) </em>

<pre>
real(r8), intent(in), dimension(n)         :: <em class=code>ens </em>
integer, intent(in)                        :: <em class=code>n </em>
real(r8), intent(in),                      :: <em class=code>obs </em>
real(r8), intent(in), dimension(ens_size)  :: <em class=code>obs_var </em>
real(r8), intent(out)                       :: <em class=code> var_ratio </em>
</pre></div>

<H3 class=indent1>Description</H3>

<P>
   Given a prior ensemble estimate, an observation, and the observational
   error variance, computes the ratio of the square of ratio of the difference between
   the ensemble mean and the observation to the expected value of this difference.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>

<TR><TD valign=top><em class=code>ens &nbsp; &nbsp; </em></TD>
    <TD>The prior ensemble expected values for this observation.</TD></TR>

<TR><TD valign=top><em class=code>n</em></TD>
    <TD>Size of the ensemble.</TD></TR>

<TR><TD valign=top><em class=code>obs &nbsp; &nbsp; </em></TD>
    <TD>The observed value.</TD></TR>

<TR><TD valign=top><em class=code>obs_var &nbsp; &nbsp; </em></TD>
    <TD>The observational error variance.</TD></TR>

<TR><TD valign=top><em class=code>var_ratio</em></TD>
    <TD>Ratio of square of difference between ensemble mean prior and
        observed value to the expected variance of this quantity.</TD></TR>

</TABLE>

</P>

<!--==================================================================-->
<!--=================== DESCRIPTION OF A NAMELIST  ===================-->

<A NAME="Namelist"></A>
<BR><HR><BR>
<H2>NAMELIST</H2>
<P>We adhere to the F90 standard of starting a namelist with an ampersand 
'&' and terminating with a slash '/'.
<div class=namelist><pre>
<em class=call>namelist / assim_tools_nml / </em> &
    prior_spread_correction, filter_kind, slope_threshold
</pre></div>

<H3 class=indent1>Discussion</H3>

<P>This namelist is read in a file called <em class=file>input.nml</em>
</P>

<TABLE border=0 cellpadding=3 width=100%>
<TR><TH align=left>Contents    </TH>
    <TH align=left>Type        </TH>
    <TH align=left>Description </TH></TR>
<TR><!--contents--><TD valign=top>prior_spread_correction             </TD>
    <!--  type  --><TD valign=top>logical <em class="unit">
    <!--descript--><TD>True if prior spread reduction correction algorithm
                      is to be used. Default is false.</TD></TR>
<TR><!--contents--><TD valign=top>filter_kind        </TD>
    <!--  type  --><TD>integer                         </TD>
    <!--descript--><TD>Selects the variant of filter to be used. 1=EAKF, 2=ENKF, 3=Kernel filter, 
                       4 = particle filter.                       </TD></TR>
<TR><!--contents--><TD valign=top>slope_threshold            </TD>
    <!--  type  --><TD>real(r8)                        </TD>
    <!--descript--><TD>Threshold value of variance ratio at which systematic error correction begins
                       to be applied if slope is not 0.                </TD></TR>
</TABLE>

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<BR><HR><BR>
<H2>FILES</H2>
<UL><LI>NONE.
</UL>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR><BR>
<H2>REFERENCES</H2>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>obs_increment</TD>
    <!-- message --><TD VALIGN=top>Illegal value of filter_kind in assim_tools namelist [1-4 OK]</TD>
    <!-- comment --><TD VALIGN=top>Only 4 variants currently supported.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>obs_increment_particle</TD>
    <!-- message --><TD VALIGN=top>Confidence slope bias correction is not implemented</TD>
    <!-- comment --><TD VALIGN=top> Can't use bias correction with particle filter at present.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>obs_increment_enkf</TD>
    <!-- message --><TD VALIGN=top>Confidence slope bias correction is not implemented</TD>
    <!-- comment --><TD VALIGN=top> Can't use bias correction with ENKF at present.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>obs_increment_kernel</TD>
    <!-- message --><TD VALIGN=top>Confidence slope bias correction is not implemented</TD>
    <!-- comment --><TD VALIGN=top> Can't use bias correction with kernel filter at present.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>update_from_obs_inc</TD>
    <!-- message --><TD VALIGN=top>The prior_spread_correction algorithm only works with EAKF filters. Do not
                                   select prior_spread_correction = .true. with other filters.</TD>
    <!-- comment --><TD VALIGN=top> Prior spread correction only works with EAKF.</TD>
</TR>
</TABLE>
</div>

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<BR><HR><BR>
<H2>KNOWN BUGS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Descibe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR><BR>
<H2>FUTURE PLANS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Have not fleshed out this part yet ... ha ha ha                  -->
<!--==================================================================-->


<H3 class=indent1>Discussion</H3>

<!--==================================================================-->

<HR>
</BODY>
</HTML>
