<HTML>
<HEAD>
<TITLE>module assim_tools_mod</TITLE>
<link rel="stylesheet" type="text/css" href="../doc/html/doc.css"></link> 
</HEAD>
<BODY>
<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<DIV ALIGN=CENTER>
<A HREF="#Interface">INTERFACE</A> / 
<A HREF="#PublicEntities">PUBLIC COMPONENTS</A> / 
<A HREF="#Namelist">NAMELIST</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A> /
<A HREF="#PrivateComponents">PRIVATE COMPONENTS</A>
</DIV>

<!--==================================================================-->

<H1>MODULE assim_tools_mod</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
<TR><TD>Contact:       </TD><TD> Jeff Anderson     </TD></TR>
<TR><TD>Revision:      </TD><TD> $Revision$ </TD></TR>
<TR><TD>Source:        </TD><TD> $URL$ </TD></TR>
<TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
<TR><TD>Change history:</TD><TD> try "svn log" or "svn diff" </TD></TR>
</TABLE>
<BR>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>
This module provides subroutines that implement the 'parallel' versions
of the sequential scalar filter algorithms. These include the standard 
sequential filter as described in Anderson (2003) along with systematic 
correction algorithms for both mean and spread. In addition, algorithms 
to do a variety of flavors of filters including the EAKF, ENKF, particle 
filter, and kernel filters are included. The parallel implementation 
that allows each observation to update all state variables that are close
to it at the same time is described in Anderson (2007).
<BR>

<!--==================================================================-->

<A NAME="OTHER MODULES USED"></A>
<BR><HR><BR>
<H2>OTHER MODULES USED</H2>
<PRE>
types_mod
utilities_mod
sort_mod
random_seq_mod
obs_sequence_mod
obs_def_mod
cov_cutoff_mod
reg_factor_mod
location_mod (model dependent choice)
ensemble_manager_mod
mpi_utilities_mod
adaptive_inflate_mod
time_manager_mod
assim_model_mod
</PRE>

<!--==================================================================-->
<!--Note to authors. The first row of the table is different.         -->

<A NAME="Interface"></A>
<BR><HR><BR>
<H2>PUBLIC INTERFACE</H2>

<TABLE>
<TR><TD><em class=call>use assim_tools_mod, only : </em></TD>
                   <TD><A HREF="#yyyroutine1">filter_assim</A></TD></TR>
</TABLE>

<BR>
<P>
Optional namelist interface
<A HREF="#Namelist"> <em class=code>&#38;assim_tools_nml</em> </A>
may be read from file <em class=file>input.nml</em>.
</P>


<!--==================================================================-->
<!-- Declare all public entities ...                                  -->
<!-- duplicate public routines template as many times as necessary    -->
<!-- make sure you replace all yyyroutine?? strings                   -->
<!--==================================================================-->

<A NAME="PublicEntities"></A>
<BR><HR><BR>
<H2>PUBLIC COMPONENTS</H2>
<BR>


<!--===================== DESCRIPTION OF SUBROUTINE =====================-->

<A NAME="yyyroutine1"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call filter_assim(ens_handle, obs_ens_handle, obs_seq, keys, 
 ens_size, num_groups, obs_val_index, inflate, ENS_MEAN_COPY, ENS_SD_COPY, 
 ENS_INF_COPY, ENS_INF_SD_COPY, OBS_KEY_COPY, OBS_GLOBAL_QC_COPY, 
 OBS_PRIOR_MEAN_START, OBS_PRIOR_MEAN_END, OBS_PRIOR_VAR_START, OBS_PRIOR_VAR_END, 
 inflate_only) </em>
 <pre>
 type(ensemble_type), intent(inout)         :: <em class=code>ens_handle</em>
 type(ensemble_type), intent(inout)         :: <em class=code>obs_ens_handle</em>
 type(obs_sequence_type), intent(in)        :: <em class=code>obs_seq</em>
 integer, intent(in)                        :: <em class=code>keys(:)</em>
 integer, intent(in)                        :: <em class=code>ens_size</em>
 integer, intent(in)                        :: <em class=code>num_groups</em>
 integer, intent(in)                        :: <em class=code>obs_val_index</em>
 type(adaptive_inflate_type), intent(inout) :: <em class=code>inflate</em>
 integer, intent(in)                        :: <em class=code>ENS_MEAN_COPY</em>
 integer, intent(in)                        :: <em class=code>ENS_SD_COPY</em>
 integer, intent(in)                        :: <em class=code>ENS_INF_COPY</em>
 integer, intent(in)                        :: <em class=code>OBS_KEY_COPY</em>
 integer, intent(in)                        :: <em class=code>OBS_GLOBAL_QC_COPY</em>
 integer, intent(in)                        :: <em class=code>OBS_PRIOR_MEAN_START</em>
 integer, intent(in)                        :: <em class=code>OBS_PRIOR_MEAN_END</em>
 integer, intent(in)                        :: <em class=code>OBS_PRIOR_VAR_START</em>
 integer, intent(in)                        :: <em class=code>OBS_PRIOR_VAR_END</em>
 logical, intent(in)                        :: <em class=code>inflate_only</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
 Does assimilation and inflation for a set of observations that is identified
by having integer indices listed in keys. Only the inflation is updated if
inflation_only is true, otherwise the state is also updated.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>ens_handle&nbsp; &nbsp; </em></TD>
     <TD>Contains state variable ensemble data and description.</TD></TR>
 <TR><TD valign=top><em class=code>obs_ens_handle&nbsp; &nbsp; </em></TD>
     <TD>Contains observation prior variable ensemble and description.</TD></TR>
 <TR><TD valign=top><em class=code>obs_seq&nbsp; &nbsp; </em></TD>
     <TD>Contains the observation sequence including observed values and 
          error variances.</TD></TR>
 <TR><TD valign=top><em class=code>keys&nbsp; &nbsp; </em></TD>
     <TD>A list of integer indices of observations in obs_seq that are 
          to be used at this time.</TD></TR>
 <TR><TD valign=top><em class=code>ens_size&nbsp; &nbsp; </em></TD>
     <TD>Number of ensemble members in state and observation prior ensembles.</TD></TR>
 <TR><TD valign=top><em class=code>num_groups&nbsp; &nbsp; </em></TD>
     <TD>Number of groups being used in assimilation.</TD></TR>
 <TR><TD valign=top><em class=code>obs_val_index&nbsp; &nbsp; </em></TD>
     <TD>Integer index of copy in obs_seq that contains the observed 
           value from instrument.</TD></TR>
 <TR><TD valign=top><em class=code>inflate&nbsp; &nbsp; </em></TD>
     <TD>Contains inflation values and all information about inflation 
         to be used.</TD></TR>
 <TR><TD valign=top><em class=code>ENS_MEAN_COPY&nbsp; &nbsp; </em></TD>
     <TD>Index of copy containing ensemble mean in ens_handle.</TD></TR>
 <TR><TD valign=top><em class=code>ENS_SD_COPY&nbsp; &nbsp; </em></TD>
     <TD>Index of copy containing ensemble standard deviation in ens_handle.</TD></TR>
 <TR><TD valign=top><em class=code>ENS_INF_COPY&nbsp; &nbsp; </em></TD>
     <TD>Index of copy containing state space inflation in ens_handle.</TD></TR>
 <TR><TD valign=top><em class=code>ENS_INF_SD_COPY&nbsp; &nbsp; </em></TD>
     <TD>Index of copy containing state space inflation standard deviation 
         in ens_handle.</TD></TR>
 <TR><TD valign=top><em class=code>OBS_KEY_COPY&nbsp; &nbsp; </em></TD>
     <TD>Index of copy containing unique key for observation in obs_ens_handle.</TD></TR>
 <TR><TD valign=top><em class=code>OBS_GLOBAL_QC_COPY&nbsp; &nbsp; </em></TD>
     <TD>Index of copy containing global quality control value in 
         obs_ens_handle.</TD></TR>
 <TR><TD valign=top><em class=code>OBS_PRIOR_MEAN_START&nbsp; &nbsp; </em></TD>
     <TD>Index of copy containing first group's prior mean in obs_ens_handle.</TD></TR>
 <TR><TD valign=top><em class=code>OBS_PRIOR_MEAN_END&nbsp; &nbsp; </em></TD>
     <TD>Index of copy containing last group's prior mean in obs_ens_handle.</TD></TR>
 <TR><TD valign=top><em class=code>OBS_PRIOR_VAR_START&nbsp; &nbsp; </em></TD>
     <TD>Index of copy containing first group's ensemble variance in 
         obs_ens_handle.</TD></TR>
 <TR><TD valign=top><em class=code>OBS_PRIOR_VAR_END&nbsp; &nbsp; </em></TD>
     <TD>Index of copy containing last group's ensemble variance in 
          obs_ens_handle.</TD></TR>
 <TR><TD valign=top><em class=code>inflate_only&nbsp; &nbsp; </em></TD>
     <TD>True if only inflation is to be updated, and not state.</TD></TR>
 </TABLE>
 <P>


<!--=================== DESCRIPTION OF A NAMELIST  ===================-->

<A NAME="Namelist"></A>
<BR><HR><BR>
<H2>NAMELIST</H2>
<P>We adhere to the F90 standard of starting a namelist with an ampersand 
'&#38;' and terminating with a slash '/'.
<div class=namelist><pre>
<em class=call>namelist / assim_tools_nml / </em> &#38;
filter_kind, cutoff, sort_obs_inc, print_every_nth_obs, &#38;
spread_restoration, sampling_error_correction, adaptive_localization_threshold
</pre></div>

<H3 class=indent1>Discussion</H3>

<P>This namelist is read in a file called <em class=file>input.nml</em>
</P>

<TABLE border=0 cellpadding=3 width=100%>
<TR><TH align=left>Contents    </TH>
    <TH align=left>Type        </TH>
    <TH align=left>Description </TH></TR>

<TR><!--contents--><TD valign=top>filter_kind  </TD>
    <!--  type  --><TD valign=top>integer      </TD>
    <!--descript--><TD>Selects the variant of filter 
        to be used. 1=EAKF, 2=ENKF, 3=Kernel filter, 
        4=particle filter.  7=Boxcar kernel filter Default: 1.</TD></TR>

<TR><!--contents--><TD valign=top>cutoff     </TD>
    <!--  type  --><TD valign=top>real(r8)   </TD>
    <!--descript--><TD>Cutoff controls a distance dependent weight that modulates
                       the impact of an observation on a state variable. The units depend
                       both on the location module being used and on the covariance cutoff
                       module options selected. Default is 0.2.</TD></TR>

<TR><!--contents--><TD valign=top>sort_obs_inc </TD>
    <!--  type  --><TD valign=top>logical      </TD>
    <!--descript--><TD> If true, the final increments from obs_increment are
                        sorted so that the mean increment value is as small
                        as possible. This minimizes regression errors when
                        non-deterministic filter or error correction algorithms
                        are applied. Default: false.</TD></TR>
 
<TR><!--contents--><TD valign=top>spread_restoration </TD>
    <!--  type  --><TD valign=top>logical            </TD>
    <!--descript--><TD> True turns on algorithm to restore amount of spread that would be
             expected to be lost if underlying obs/state variable correlation were really
             0.  Default: false </TD></TR>

<TR><!--contents--><TD valign=top>sampling_error_correction</TD>
    <!--  type  --><TD valign=top>logical                  </TD>
    <!--descript--><TD> True uses special input files generated by correl_error.f90
     in system_simulation to reduce errors in the regression step. Special input
     files corresponding with the ensemble size being used are required. This 
     option is not yet fully supported. Contact the DART developers group if you 
     have questions. 
               Default: false </TD></TR>

<TR><!--contents--><TD valign=top>adaptive_localization_threshold</TD>
    <!--  type  --><TD valign=top>integer</TD>
    <!--descript--><TD> Used to reduce the impact of observations in densely observed
     regions. If the number of observations close to a given observation is greater
     than the threshold number, the cutoff radius for localization is adjusted to
     try to make the number of observations close to the given observation be
     the threshold number. This should be dependent on the location module and
     is tuned for a three_dimensional spherical implementation for numerical
     weather prediction models at present.
               Default: -1 </TD></TR>

<TR><!--contents--><TD valign=top>print_every_nth_obs </TD>
    <!--  type  --><TD valign=top>integer             </TD>
    <!--descript--><TD> If set to a value <em class=code>N</em> greater than 0, 
             the observation assimilation loop prints out a progress message 
             every <em class=code>N</em>th observations.  This can be useful to
             estimate the expected run time for a large observation file, 
             or to verify progress is being made in cases with suspected problems.
             Default: 0 </TD></TR>


</TABLE>

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<BR><HR><BR>
<H2>FILES</H2>
<UL><LI>input.nml
<LI>assim_tools_mod.nml in input.nml
</UL>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR><BR>
<H2>REFERENCES</H2>
Anderson, Jeffrey L. "A Local Least Squares Framework for Ensemble Filtering"
April 2003, MWR 131, pp 634-642

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>assim_tools_init</TD>
    <!-- message --><TD VALIGN=top>cant combine spread_restoration and filter_kind ###</TD>
    <!-- comment --><TD VALIGN=top> Spread restoration only compatible with filter_kind 1 </TD>
</TR>

</TR>
<TR><!-- routine --><TD VALIGN=top>obs_increment</TD>
    <!-- message --><TD VALIGN=top>Illegal value of filter_kind in assim_tools namelist [1-4 OK]</TD>
    <!-- comment --><TD VALIGN=top>Only 1-6 currently supported.</TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>obs_increment_eakf <BR>
                                   obs_increment_ran_kf <BR>
                                   obs_increment_det_kf </TD> 
    <!-- message --><TD VALIGN=top>Both obs_var and prior_var are zero. This is inconsistent</TD>
    <!-- comment --><TD VALIGN=top>Product of two delta functions doesn't work.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>get_correction_from_file</TD>
    <!-- message --><TD VALIGN=top>Use less than 10000 ensemble</TD>
    <!-- comment --><TD VALIGN=top> File only works up to 9999 members.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>get_correction_from_file</TD>
    <!-- message --><TD VALIGN=top>Correction file ______ does not exist.</TD>
    <!-- comment --><TD VALIGN=top> Couldn't find the correction file in the working directory.</TD>
</TR>

</TR>
</TABLE>
</div>

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<BR><HR><BR>
<H2>KNOWN BUGS</H2>
<P>
The current version of the systematic error correction algorithm does
not work in a logical fashion with the parallel region assimilation 
feature. 
</P>

<!--==================================================================-->
<!-- Descibe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR><BR>
<H2>FUTURE PLANS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Have not fleshed out this part yet ... ha ha ha                  -->
<!--==================================================================-->

<A NAME="PrivateComponents"></A>
<BR><HR><BR>
<H2>PRIVATE COMPONENTS</H2>

<div class=routine>
<pre>
</div>

<H3 class=indent1>Discussion</H3>

<!--==================================================================-->

<HR>
</BODY>
</HTML>
