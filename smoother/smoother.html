<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<HTML>
<TITLE>program smoother</TITLE>
<link rel=stylesheet type=text/css href=../doc/html/doc.css>
<BODY>

<DIV ALIGN=CENTER>
<A HREF="#PublicEntities">PUBLIC COMPONENTS</A> / 
<A HREF="#Namelist">NAMELIST</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A> /
<A HREF="#PrivateComponents">PRIVATE COMPONENTS</A>
</DIV>

<!--==================================================================-->

<H1>PROGRAM smoother</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
   <TR><TD>Contact:       </TD><TD> Jeff Anderson                </TD></TR>
   <TR><TD>Reviewers:     </TD><TD> &nbsp;                       </TD></TR>
   <TR><TD>Revision:      </TD><TD> $Revision$             </TD></TR>
   <TR><TD>Release Name:  </TD><TD> $Name$                       </TD></TR>
   <TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
   <TR><TD>Change history:</TD><TD> see CVS log </TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>

<P>
   Main program for driving smoother calculations using ensemble filter update
   algorithms available in DART. This program 
   provides a number of options that are driven from its namelist.
   The namelist options are nearly identical to the filter namelist options. Additional
   namelist parameters have been added to handle features specific to the smoother, specifically
   the restart capabilities for the smoother. The
   number of assimilation steps to be done are controlled by the input
   observation sequence and by the time-stepping capabilities of the model
   being used in the assimilation. This documentation was created for the
   I-release of DART.
</P>

<P>
   Quality control flags for observations are set in smoother. The quality
   control flags work in a manner identical to filter. If forward 
   observation operators cannot be computed for any ensemble member, the
   quality control flag for the observation is incremented by 1000 for the
   prior and 100000 for a violation when computing posterior diagnostics.
</P>

<P>
   The smoother also performs an outlier test on observations which set the 
   quality control flags (see outlier_threshold in namelist). Once again, this 
   feature is identical to the filter.
</P>

<P>
Optional namelist interface
<A HREF="#Namelist"> <em class=code>&#38;smoother_nml</em> </A>
may be read from file <em class=file>input.nml</em>.
</P>

<!--==================================================================-->

<A NAME="OTHER MODULES USED"></A>
<BR><HR><BR>
<H2>OTHER MODULES USED (note: the key difference with the filter is assim_tools_smoother_mod is used
- assim_tools_smoother_mod contains alterations to subroutines filter_assim_region, filter_assim
and asyn_assim_region which allow the smoother to run)</H2>
<PRE>
types_mod
obs_sequence_mod
obs_def_mod
time_manager_mod
utilities_mod
assim_model_mod
random_seq_mod
assim_tools_smoother_mod
obs_model_mod
ensemble_manager
</PRE>


<!--==================================================================-->
<!--=================== DESCRIPTION OF A NAMELIST  ===================-->

<A NAME="Namelist"></A>
<BR><HR><BR>
<H2>NAMELIST</H2>
<P>We adhere to the F90 standard of starting a namelist with an ampersand 
'&#38;' and terminating with a slash '/'.
<div class=namelist><pre>
<em class=call>namelist / smoother_nml / </em> &
      async, adv_ens_command, ens_size, cov_inflate, 
      start_from_smoother_restart, output_smoother_restart,
      smoother_restart_in_base, smoother_restart_out_base,
      start_from_restart, restart_in_file_name,
      obs_sequence_in_name, obs_sequence_out_name,  
      init_time_days, init_time_seconds, 
      output_state_ens_mean, output_state_ens_spread, 
      output_obs_ens_mean,   output_obs_ens_spread, 
      num_output_state_members, num_output_obs_members, 
      output_interval,  num_groups, outlier_threshold, lag 
</pre></div>

<H3 class=indent1>Discussion</H3>

<P>This namelist is read in a file called <em class=file>input.nml</em>
</P>

<TABLE border=0 cellpadding=3 width=100%>
<TR><TH align=left>Contents    </TH>
    <TH align=left>Type        </TH>
    <TH align=left>Description </TH></TR>
<TR><!--contents--><TD valign=top>async                        </TD>
    <!--  type  --><TD valign=top>integer                      </TD>
    <!--descript--><TD>Controls whether models are advanced via a subroutine call or
                       by writing initial condition files for ensemble members to 
                       disk and having shellscript advance the model. <BR>
                       0 = advance by subroutine.  Default <BR>
                       1 = shell advance using shell script piped to filter. <BR>
                       2 = advance by F90 calls to shell to advance model. <BR>
                       3 = model advanced when signalled by a signal file, which is
                       is written out by filter (used for running filter on a compute node 
                       separate from the model advances). </TD></TR>
<TR><!--contents--><TD valign=top> ens_size       </TD>
    <!--  type  --><TD valign=top>integer                         </TD>
    <!--descript--><TD>Number of ensemble members to be integrated. 
                       Default is 20.</TD></TR>  
<TR><!--contents--><TD valign=top>cov_inflate                  </TD>
    <!--  type  --><TD valign=top>real(r8)                     </TD>
    <!--descript--><TD>Covariance inflation factor applied to prior estimate before each
                       assimilation step. Default is 1.0 (no inflation).</TD></TR> 
<TR><!--contents--><TD valign=top>start_from_smoother_restart           </TD>
    <!--  type  --><TD valign=top>logical                      </TD>
    <!--descript--><TD>Should initial ensemble states come from (a) restart file(s). 
                       Default is .false. Please note that if this option is .false., 
		       the restart is then controlled by the logical start_from_restart.
		       If start_from_restart is true, then we start from a filtered
		       state in filename restart_in_file_name, otherwise, a cold initialization
		       is used in the same manner as filter.		       
		       </TD></TR>
		       

<TR><!--contents--><TD valign=top>output_smoother_restart                  </TD>
    <!--  type  --><TD valign=top>logical                    </TD>
    <!--descript--><TD>Controls whether restart files for the lagged smoother states
                       are created or not. Note that one restart file for each lag
		       from 0 to lag is created when this logical is .true.
		       </TD></TR> 		       
	
	
<TR><!--contents--><TD valign=top>smoother_restart_in_base                  </TD>
    <!--  type  --><TD valign=top>character(len=129)                    </TD>
    <!--descript--><TD> The character `tag' associated with the smoother restart
    files. Suppose the character specified is `s'. If one is running at lag = 5
    smoother, then the program requires restart files s000 (lag 0), s001, s002, 
    s003, s004 and s005 to be available. If not present, program failure will occur. </TD></TR> 	



<TR><!--contents--><TD valign=top>smoother_restart_out_base                  </TD>
    <!--  type  --><TD valign=top>character(len=129)                </TD>
    <!--descript--><TD> The character `tag' associated with the smoother restart
    files that one wants to output. Suppose the character specified is `s'. If one is running at lag = 5
    smoother, then the program will output restart files s000 (lag 0), s001, s002, 
    s003, s004 and s005 to be available for the subsequent run of
    the smoother. </TD></TR> 		       
	
	
		       
		       
		       
<TR><!--contents--><TD valign=top>start_from_restart             </TD>
    <!--  type  --><TD valign=top>logical                      </TD>
    <!--descript--><TD> First of all, this logical is only of consequence if
    start_from_smoother_restart = .false.. When this is the case, the smoother
    starts without any previously saved lagged smoother states. 
    When start_from_smoother_restart = .false., the lagged
    states are just set to the filtered state initially.
    Once the smoother runs for sufficiently long, valid smoother states are generated.
    Now, when start_from_smoother_restart = .false., start_from_restart controls *which*
    filtered state we start from. If start_from_restart = .true. we start by loading
    up the initial conditions in filename restart_in_file_name, otherwise we start
    from a cold initialization as in the filter program.           </TD></TR>
    
<TR><!--contents--><TD valign=top>restart_in_file_name               </TD>
    <!--  type  --><TD valign=top>character(len=129)                </TD>
    <!--descript--><TD> If start_from_restart = .true. *and* start_from_smoother_restart = .false.
    we start from the filter initial conditions specified by this filename.
    File name (root) for a file(s) containing restart state for all 
                       ensemble members.  Multiple files have extensions ".####", 
                       where #### is a 4 digit number representing the ensemble member. 
                       Default is 'filter_ics'.
     </TD></TR> 	    
    
<TR><!--contents--><TD valign=top>obs_sequence_in_name               </TD>
    <!--  type  --><TD valign=top>character(len=129)                </TD>
    <!--descript--><TD> File name that contains an observation sequence file.
                       Default is 'obs_seq.out'.  </TD></TR> 	    
    
    
<TR><!--contents--><TD valign=top>obs_sequence_out_name               </TD>
    <!--  type  --><TD valign=top>character(len=129)                </TD>
    <!--descript--><TD> Uknown purpose. Ask JLA. Default is 'obs_seq.final'. </TD></TR> 	
    
    
    
    
        
		       
		       
<TR><!--contents--><TD valign=top>init_time_days               </TD>
    <!--  type  --><TD valign=top>integer                      </TD>
    <!--descript--><TD>Initial time of model (time is in days and seconds; see
                       time_manager. If init_time_days and init_time_seconds are 
                       less than 0, the initial time comes from the time in 
                       the restart file. Default value is 0. </TD></TR> 
<TR><!--contents--><TD valign=top>init_time_seconds            </TD>
    <!--  type  --><TD valign=top>integer                      </TD>
    <!--descript--><TD>Initial time of model in seconds. Default is 0.  </TD></TR>
<TR><!--contents--><TD valign=top>output_state_ens_mean        </TD>
    <!--  type  --><TD valign=top>logical                      </TD>
    <!--descript--><TD>Output ensemble mean in state diagnostic files. </TD></TR>
<TR><!--contents--><TD valign=top>output_state_ens_spread      </TD>
    <!--  type  --><TD valign=top>logical                      </TD>
    <!--descript--><TD>Output ensemble spread in state diagnostic files. </TD></TR>
<TR><!--contents--><TD valign=top>output_obs_ens_mean          </TD>
    <!--  type  --><TD valign=top>logical                      </TD>
    <!--descript--><TD>Output ensemble mean in observation output file. </TD></TR>
<TR><!--contents--><TD valign=top>output_obs_ens_spread
    <!--  type  --><TD valign=top>logical                         </TD>
    <!--descript--><TD>Output ensemble spread in observation output file. </TD></TR>
<TR><!--contents--><TD valign=top>num_output_state_members     </TD>
    <!--  type  --><TD valign=top>integer                      </TD>
    <!--descript--><TD>This number of ensemble members is output to the
                       state diagnostics file. If this is less than the total
                       number of ensemble members the first subset is output. 
                       Default is 0.</TD></TR>
<TR><!--contents--><TD valign=top>num_output_obs_members       </TD>
    <!--  type  --><TD valign=top>integer                      </TD>
    <!--descript--><TD>This number of ensemble members is output to the
                       observation output file. If this is less than the total
                       number of ensemble members the first subset is output. 
                       Default is 0.</TD></TR>
<TR><!--contents--><TD valign=top>output_interval              </TD>
    <!--  type  --><TD valign=top>integer                      </TD>
    <!--descript--><TD>The frequency with which output state diagnostics are 
                       written.  Units are in assimilation times.
                       Default value is 1 meaning output is written at
                       every observation time. </TD></TR>
<TR><!--contents--><TD valign=top>num_groups                   </TD>
    <!--  type  --><TD valign=top>integer                      </TD>
    <!--descript--><TD>Number of groups for hierarchical group filter. Should 
                       be a divisor of the ensemble size. Default is 1. </TD></TR>
<TR><!--contents--><TD valign=top>outlier_threshold            </TD>
    <!--  type  --><TD valign=top>real(r8)                     </TD>
    <!--descript--><TD>Discard all observations where the prior ensemble mean
                       and the observation value differ by more than this many
                       of the expected standard deviations. A quality control
                       flag value is incremented by 100 if this check is
                       violated for the prior ensemble mean and by 400 it this check
                       is violated for the posterior ensemble mean. Negative value 
                       means no quality control of this kind is performed. 
                       Default value is -1.0 </TD></TR>
<TR><!--contents--><TD valign=top>lag               </TD>
    <!--  type  --><TD valign=top>integer                      </TD>
    <!--descript--><TD>Integer indicating up to how many lags one wants to compute. 
    Default value is 0 (no lag calculations). Lag can not exceed 1000. </TD></TR>		       
		       
		       
</TABLE>

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<BR><HR><BR>
<H2>FILES</H2>
<UL><LI>observation sequence input file; from obs_sequence_in_name
    <LI>state restart input file; from restart_in_file_name (only used if no smoother restart)
    <LI>smoother restart input file(s); from smoother_restart_in_base (only used if we do a smoother restart)
    <LI>smoother restart output file(s); from smoother_restart_out_base (always written)
    <LI>output state space prior diagnostics file; Prior_Diag.nc
    <LI>output state space posterior diagnostics file; Posterior_Diag.nc
    <LI>output state space lag (0 ... lag) diagnostics file; Posterior_Lag_*lag*.nc (*lag* goes from 0000, ..., 1000).
    Each Posterior_Lag_*lag*.nc file contains data for a given lag.
    <LI>output observation space diagnostic file; from obs_sequence_out_name
    <LI>smoother.nml in input.nml
</UL>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR><BR>
<H2>REFERENCES</H2>

<!--==================================================================--> 
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>filter_generate_copy_meta_data</TD>
    <!-- message --><TD VALIGN=top>output metadata in filter needs ensemble size < 10000</TD>
    <!-- comment --><TD VALIGN=top>Ensemble sizes greater than require modifications to output ensemble code. </TD>
<TR><!-- routine --><TD VALIGN=top>filter_get_obs_info</TD>
    <!-- message --><TD VALIGN=top>Did not find observation copy with metadata "observations"</TD>
    <!-- comment --><TD VALIGN=top>None of the copies of data in the obs_seq file is an "observation"</TD>
</TR>
</TR>

</TABLE>
</div>

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<BR><HR><BR>
<H2>KNOWN BUGS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Descibe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR><BR>
<H2>FUTURE PLANS</H2>
<P>
Possibilities: add in parallel capability. As it stands, the smoother is 
not compatible with the parallel option. 
</P>

<!--==================================================================-->
<!-- Have not fleshed out this part yet ... ha ha ha                  -->
<!--==================================================================-->


<H3 class=indent1>Discussion</H3>

Please see a brief write up written by Shree Khare briefly explaining how the 
smoother output is formatted and its meaning. There is text and figures contained
in the files smootherdatadartexplain.ps (or pdf) and smootherdatadart.ps (or pdf)
can be found in the ~/DART/smoother directory. 


<!--==================================================================-->

<HR>
</BODY>
</HTML>
