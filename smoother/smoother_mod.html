<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<HTML>
<TITLE>module smoother_mod</TITLE>
<link rel=stylesheet type=text/css href=doc.css>
<BODY>

<DIV ALIGN=CENTER>
<A HREF="#Interface">INTERFACE</A> / 
<A HREF="#PublicEntities">PUBLIC COMPONENTS</A> / 
<A HREF="#Namelist">NAMELIST</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A> /
<A HREF="#PrivateComponents">PRIVATE COMPONENTS</A>
</DIV>

<!--==================================================================-->

<H1>MODULE smoother_mod</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
   <TR><TD>Contact:       </TD><TD> Jeff Anderson                </TD></TR>
   <TR><TD>Reviewers:     </TD><TD> &nbsp;                       </TD></TR>
   <TR><TD>Revision:      </TD><TD> $Revision$             </TD></TR>
   <TR><TD>Release Name:  </TD><TD> $Name$                       </TD></TR>
   <TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
   <TR><TD>Change history:</TD><TD> see CVS log (cop-out, I know)</TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>

<P>
   A note about documentation style. Optional arguments are enclosed in
   brackets <em class=optionalcode>[like this]</em>.
</P>
<P>
  Implements a fixed lag ensemble smoother as part of the filter. For now,
this is done inefficiently with a separate call to filter_assim in 
assim_tools_mod for each lag. 
</P>

<!--==================================================================-->

<A NAME="OTHER MODULES USED"></A>
<BR><HR><BR>
<H2>OTHER MODULES USED</H2>
<PRE>
types_mod
mpi_utilities_mod
utilities_mod
ensemble_manager_mod
time_manager_mod
assim_model_mod
assim_tools_mod
obs_sequence_mod
adaptive_inflate_mod
</PRE>

<!--==================================================================-->
<!--Note to authors. The first row of the table is different.         -->

<A NAME="Interface"></A>
<BR><HR><BR>
<H2>PUBLIC INTERFACE</H2>

<TABLE>
<TR><TD><em class=call>use smoother_mod, only : </em></TD>
                   <TD><A HREF="#smoother_read_restart">smoother_read_restart</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#advance_smoother">advance_smoother</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#smoother_generate_copy_meta_data">smoother_generate_copy_meta_data</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#smoother_write_restart">smoother_write_restart</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#init_smoother">init_smoother</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#do_smoothing">do_smoothing</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#smoother_mean_spread">smoother_mean_spread</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#smoother_assim">smoother_assim</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#filter_state_space_diagnostics">filter_state_space_diagnostics</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#smoother_state_space_diagnostics">smoother_state_space_diagnostics</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#smoother_end">smoother_end</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#smoother_inc_lags">smoother_inc_lags</A></TD></TR>
</TABLE>

<H3 class=indent1>NOTES</H3>

<P>
Optional namelist interface <em class=code>&#38;lim_obs_seq_nml</em> 
may be read from file <em class=file>input.nml</em>.
</P>

<!--==================================================================-->
<!-- Declare all public entities ...                                  -->
<!-- duplicate public routines template as many times as necessary    -->
<!-- make sure you replace all yyyroutine?? strings                   -->
<!--==================================================================-->

<A NAME="PublicEntities"></A>
<BR><HR><BR>
<H2>PUBLIC COMPONENTS</H2>
<P>fill in text here
</P>


 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="smoother_read_restart"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call smoother_read_restart(ens_handle,ens_size,model_size,time1
 ,init_time_days) </em>
 <pre>
 type(ensemble_type), intent(inout) :: <em class=code>ens_handle</em>
 integer, intent(in)                :: <em class=code>ens_size</em>
 integer, intent(in)                :: <em class=code>model_size</em>
 type(time_type), intent(inout)     :: <em class=code>time1</em>
 integer, intent(in)                :: <em class=code>init_time_days</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Reads in ensemble of states for all lag estimates from a restart file.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>ens_handle&nbsp; &nbsp; </em></TD>
     <TD>Handle of ensemble manager structure of single state; copied into all lags for startup.</TD></TR>
 <TR><TD valign=top><em class=code>ens_size&nbsp; &nbsp; </em></TD>
     <TD>Size of the ensemble.</TD></TR>
 <TR><TD valign=top><em class=code>model_size&nbsp; &nbsp; </em></TD>
     <TD>Size of the model state vector.</TD></TR>
 <TR><TD valign=top><em class=code>time1&nbsp; &nbsp; </em></TD>
     <TD>Overwrite the time in the restart file with this value if init_time_day
 s is non-negative.</TD></TR>
 <TR><TD valign=top><em class=code>init_time_days&nbsp; &nbsp; </em></TD>
     <TD>If non-negative, use time1 instead of time in restart file.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->



 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="advance_smoother"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call advance_smoother(ens_handle) </em>
 <pre>
 type(ensemble_type), intent(in) :: <em class=code>ens_handle</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
 Advances smoother state estimates at all lags forward in time. This
entails copying the most recent smoother state, contained in
ens_handle, into the lag 1 smoother state and pushing back all other
lags by 1 (i.e. lag 1 becomes lag2, etc.).
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>ens_handle&nbsp; &nbsp; </em></TD>
     <TD>Ensemble handle with most recent filtered state.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->

<!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="smoother_generate_copy_meta_data"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call smoother_generate_copy_meta_data(output_state_ens_mean,out
 put_state_ens_spread,num_output_state_members) </em>
 <pre>
 logical, intent(in) :: <em class=code>output_state_ens_mean</em>
 logical, intent(in) :: <em class=code>output_state_ens_spread</em>
 integer, intent(in) :: <em class=code>num_output_state_members</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Initializes the metadata required for the smoother state space diagnostic
files.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>output_state_ens_mean&nbsp; &nbsp; </em></TD>
     <TD>True if smoother state space output should include ensemble mean.</TD></TR>
 <TR><TD valign=top><em class=code>output_state_ens_spread&nbsp; &nbsp; </em></TD>
     <TD>True if smoother state space output should include ensemble spread.</TD></TR>
 <TR><TD valign=top><em class=code>num_output_state_members&nbsp; &nbsp; </em></TD>
     <TD>Number of copies of smoother state vector that should be in state space
  diagnostic output.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="smoother_write_restart"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call smoother_write_restart(start_copy,end_copy) </em>
 <pre>
 integer, intent(in) :: <em class=code>start_copy</em>
 integer, intent(in) :: <em class=code>end_copy</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Outputs restart files for all lags of smoother state. Integer arguments
specify the start and end global indices of a continguous set of copies that
contain the ensemble members.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>start_copy&nbsp; &nbsp; </em></TD>
     <TD>Global index of ensemble copy that starts the actual ensemble members
       for smoother.</TD></TR>
 <TR><TD valign=top><em class=code>end_copy&nbsp; &nbsp; </em></TD>
     <TD>Global index of ensemble copy that ends the actual ensemble members for
  smoother.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->


 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="init_smoother"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call init_smoother(ens_handle,POST_INF_COPY,POST_INF_SD_COPY) </em>
 <pre>
 type(ensemble_type), intent(inout) :: <em class=code>ens_handle</em>
 integer, intent(in)                :: <em class=code>POST_INF_COPY</em>
 integer, intent(in)                :: <em class=code>POST_INF_SD_COPY</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Initializes the storage needed for a smoother. Also initializes an adaptive
inflation type that does NO inflation (not currently supported for smoothers).
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>ens_handle&nbsp; &nbsp; </em></TD>
     <TD>An ensemble handle for the filter that contains information about 
        ensemble and model size.</TD></TR>
 <TR><TD valign=top><em class=code>POST_INF_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index of ensemble copy that holds posterior state space 
       inflation values.</TD></TR>
 <TR><TD valign=top><em class=code>POST_INF_SD_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index of ensemble copy that holds posterior inflation standard 
       deviation values.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A FUNCTION ========================-->
 <A NAME="do_smoothing"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> var = do_smoothing() </em>
 <pre>
 logical, intent(out) :: <em class=code>do_smoothing</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
 Returns true if smoothing is to be done, else false.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>do_smoothing&nbsp; &nbsp; </em></TD>
     <TD>Returns true if smoothing is to be done.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->


 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="smoother_mean_spread"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call smoother_mean_spread(ens_size,ENS_MEAN_COPY,ENS_SD_COPY,
      output_state_ens_mean,output_state_ens_spread) </em>
 <pre>
 integer, intent(in) :: <em class=code>ens_size</em>
 integer, intent(in) :: <em class=code>ENS_MEAN_COPY</em>
 integer, intent(in) :: <em class=code>ENS_SD_COPY</em>
 logical, intent(in) :: <em class=code>output_state_ens_mean</em>
 logical, intent(in) :: <em class=code>output_state_ens_spread</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Computes the ensemble mean (and spread if required) of all state variables
for all lagged ensembles. Spread is only computed if it is required for
output.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>ens_size&nbsp; &nbsp; </em></TD>
     <TD>Size of ensemble.</TD></TR>
 <TR><TD valign=top><em class=code>ENS_MEAN_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index of copy that stores ensemble mean.</TD></TR>
 <TR><TD valign=top><em class=code>ENS_SD_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index of copy that stores ensemble spread.</TD></TR>
 <TR><TD valign=top><em class=code>output_state_ens_mean&nbsp; &nbsp; </em></TD>
     <TD>True if the ensemble mean is to be output to state diagnostic file.</TD></TR>
 <TR><TD valign=top><em class=code>output_state_ens_spread&nbsp; &nbsp; </em></TD>
     <TD>True if ensemble spread is to be output to state diagnostic file.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="smoother_assim"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call smoother_assim(obs_ens_handle,seq,keys,ens_size,num_groups
 ,obs_val_index,ENS_MEAN_COPY,ENS_SD_COPY,PRIOR_INF_COPY,PRIOR_INF_SD_COPY,
OBS_KEY_COPY,OBS_GLOBAL_QC_COPY,OBS_PRIOR_MEAN_START,OBS_PRIOR_MEAN_END,
OBS_PRIOR_VAR_START,OBS_PRIOR_VAR_END) </em>
 <pre>
 type(ensemble_type), intent(inout)  :: <em class=code>obs_ens_handle</em>
 type(obs_sequence_type), intent(in) :: <em class=code>seq</em>
 integer, dimension(:), intent(in)   :: <em class=code>keys</em>
 integer, intent(in)                 :: <em class=code>ens_size</em>
 integer, intent(in)                 :: <em class=code>num_groups</em>
 integer, intent(in)                 :: <em class=code>obs_val_index</em>
 integer, intent(in)                 :: <em class=code>ENS_MEAN_COPY</em>
 integer, intent(in)                 :: <em class=code>ENS_SD_COPY</em>
 integer, intent(in)                 :: <em class=code>PRIOR_INF_COPY</em>
 integer, intent(in)                 :: <em class=code>PRIOR_INF_SD_COPY</em>
 integer, intent(in)                 :: <em class=code>OBS_KEY_COPY</em>
 integer, intent(in)                 :: <em class=code>OBS_GLOBAL_QC_COPY</em>
 integer, intent(in)                 :: <em class=code>OBS_PRIOR_MEAN_START</em>
 integer, intent(in)                 :: <em class=code>OBS_PRIOR_MEAN_END</em>
 integer, intent(in)                 :: <em class=code>OBS_PRIOR_VAR_START</em>
 integer, intent(in)                 :: <em class=code>OBS_PRIOR_VAR_END</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Does assimilation of a set of observations for each smoother lag.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>obs_ens_handle&nbsp; &nbsp; </em></TD>
     <TD>Handle for ensemble manager holding prior estimates of observations.</TD></TR>
 <TR><TD valign=top><em class=code>seq&nbsp; &nbsp; </em></TD>
     <TD>Observation sequence being assimilated.</TD></TR>
 <TR><TD valign=top><em class=code>keys&nbsp; &nbsp; </em></TD>
     <TD>A one dimensional array containing indices in seq of observations to as
 similate at current time.</TD></TR>
 <TR><TD valign=top><em class=code>ens_size&nbsp; &nbsp; </em></TD>
     <TD>Ensemble size.</TD></TR>
 <TR><TD valign=top><em class=code>num_groups&nbsp; &nbsp; </em></TD>
     <TD>Number of groups in filter.</TD></TR>
 <TR><TD valign=top><em class=code>obs_val_index&nbsp; &nbsp; </em></TD>
     <TD>Integer index of copy of data in seq that contains the observed value 
       from instruments.</TD></TR>
 <TR><TD valign=top><em class=code>ENS_MEAN_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index in smoother's state ensemble that holds ensemble mean.</TD></TR>
 <TR><TD valign=top><em class=code>ENS_SD_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index in smoother's state ensemble that holds ensemble standard deviation.</TD></TR>
 <TR><TD valign=top><em class=code>PRIOR_INF_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index in obs_ens_handle that holds inflation values (not used for smoother).</TD></TR>
 <TR><TD valign=top><em class=code>PRIOR_INF_SD_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index in obs_ens_handle that holds inflation sd values (not used
  for smoother).</TD></TR>
 <TR><TD valign=top><em class=code>OBS_KEY_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index in obs_ens_handle that holds the key for the observation.</TD></TR>
 <TR><TD valign=top><em class=code>OBS_GLOBAL_QC_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index in obs_ens_handle that holds the quality control value.</TD></TR>
 <TR><TD valign=top><em class=code>OBS_PRIOR_MEAN_START&nbsp; &nbsp; </em></TD>
     <TD>Global index in obs_ens_handle that holds the first group's prior mean.  </TD></TR>
 <TR><TD valign=top><em class=code>OBS_PRIOR_MEAN_END&nbsp; &nbsp; </em></TD>
     <TD>Global index in obs_ens_handle that holds the last group's prior mean.</TD></TR>
 <TR><TD valign=top><em class=code>OBS_PRIOR_VAR_START&nbsp; &nbsp; </em></TD>
     <TD>Global index in obs_ens_handle that holds the first group's prior variance.</TD></TR>
 <TR><TD valign=top><em class=code>OBS_PRIOR_VAR_END&nbsp; &nbsp; </em></TD>
     <TD>Global index in obs_ens_handle that holds the last group's prior variance.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="filter_state_space_diagnostics"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call filter_state_space_diagnostics(out_unit,ens_handle,
model_size,output_state_ens_mean,output_state_ens_spread,num_output_state_members,
output_state_mean_index,output_state_spread_index,ENS_MEAN_COPY,ENS_SD_COPY,inflate,
INF_COPY,INF_SD_COPY) </em>
 <pre>
 type(netcdf_file_type), intent(inout)   :: <em class=code>out_unit</em>
 type(ensemble_type), intent(inout)      :: <em class=code>ens_handle</em>
 integer, intent(in)                     :: <em class=code>model_size</em>
 logical, intent(in)                     :: <em class=code>output_state_ens_mean </em>
 logical, intent(in)                     :: <em class=code>output_state_ens_spread</em>
 integer, intent(in)                     :: <em class=code>num_output_state_members</em>
 integer, intent(in)                     :: <em class=code>output_state_mean_index</em>
 integer, intent(in)                     :: <em class=code>output_state_spread_index</em>
 integer, intent(in)                     :: <em class=code>ENS_MEAN_COPY</em>
 integer, intent(in)                     :: <em class=code>ENS_SD_COPY</em>
 type(adaptive_inflate_type), intent(in) :: <em class=code>inflate</em>
 integer, intent(in)                     :: <em class=code>INF_COPY</em>
 integer, intent(in)                     :: <em class=code>INF_SD_COPY</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Writes state space diagnostic values including ensemble members, mean and
spread, and inflation mean and spread to a netcdf file.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>out_unit&nbsp; &nbsp; </em></TD>
     <TD>Descriptor for the netcdf file being written.</TD></TR>
 <TR><TD valign=top><em class=code>ens_handle&nbsp; &nbsp; </em></TD>
     <TD>Ensemble handle whose state space values are to be written.</TD></TR>
 <TR><TD valign=top><em class=code>model_size&nbsp; &nbsp; </em></TD>
     <TD>Size of the model state vector.</TD></TR>
 <TR><TD valign=top><em class=code>output_state_ens_mean&nbsp; &nbsp; </em></TD>
     <TD>True if the ensemble mean values are to be output.</TD></TR>
 <TR><TD valign=top><em class=code>output_state_ens_spread&nbsp; &nbsp; </em></TD>
     <TD>True if the ensemble spread values are to be output.</TD></TR>
 <TR><TD valign=top><em class=code>num_output_state_members&nbsp; &nbsp; </em></TD>
     <TD>Number of individual state members to be output.</TD></TR>
 <TR><TD valign=top><em class=code>output_state_mean_index&nbsp; &nbsp; </em></TD>
     <TD>Index in netcdf file for ensemble mean.</TD></TR>
 <TR><TD valign=top><em class=code>output_state_spread_index&nbsp; &nbsp; </em></TD>
     <TD>Index in netcdf file for ensemble spread.</TD></TR>
 <TR><TD valign=top><em class=code>ENS_MEAN_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index in ens_handle for ensemble mean.</TD></TR>
 <TR><TD valign=top><em class=code>ENS_SD_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index in ens_handle for ensemble spread.</TD></TR>
 <TR><TD valign=top><em class=code>inflate&nbsp; &nbsp; </em></TD>
     <TD>Contains description and values of state space inflation.</TD></TR>
 <TR><TD valign=top><em class=code>INF_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index in ens_handle of inflation values.</TD></TR>
 <TR><TD valign=top><em class=code>INF_SD_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index in ens_handle of inflation standard deviation values.</TD>
 </TR>
 </TABLE>
 <P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="smoother_state_space_diagnostics"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call smoother_state_space_diagnostics(model_size,
output_state_ens_mean,output_state_ens_spread,num_output_state_members,
ENS_MEAN_COPY,ENS_SD_COPY,POST_INF_COPY,POST_INF_SD_COPY) </em>
 <pre>
 integer, intent(in) :: <em class=code>model_size</em>
 logical, intent(in) :: <em class=code>output_state_ens_mean</em>
 logical, intent(in) :: <em class=code>output_state_ens_spread</em>
 integer, intent(in) :: <em class=code>num_output_state_members</em>
 integer, intent(in) :: <em class=code>ENS_MEAN_COPY</em>
 integer, intent(in) :: <em class=code>ENS_SD_COPY</em>
 integer, intent(in) :: <em class=code>POST_INF_COPY</em>
 integer, intent(in) :: <em class=code>POST_INF_SD_COPY</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Outputs state space diagnostics files for all smoother lags.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>model_size&nbsp; &nbsp; </em></TD>
     <TD>Size of the model state vector.</TD></TR>
 <TR><TD valign=top><em class=code>output_state_ens_mean&nbsp; &nbsp; </em></TD>
     <TD>True if the ensemble mean is to be output in state space diagnostics file.</TD></TR>
 <TR><TD valign=top><em class=code>output_state_ens_spread&nbsp; &nbsp; </em></TD>
     <TD>True if the ensemble spread is to be output in the state space diagnostics file.</TD></TR>
 <TR><TD valign=top><em class=code>num_output_state_members&nbsp; &nbsp; </em></TD>
     <TD>Number of state copies to be output in the state space diagnostics file.</TD></TR>
 <TR><TD valign=top><em class=code>ENS_MEAN_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index of the ensemble mean in the lag smoother ensemble handles. </TD></TR>
 <TR><TD valign=top><em class=code>ENS_SD_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index of the ensemble spread in the lag smoother ensemble handles.</TD></TR>
 <TR><TD valign=top><em class=code>POST_INF_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index of the inflation value in the lag smoother ensemble handles
        (not currently used).</TD></TR>
 <TR><TD valign=top><em class=code>POST_INF_SD_COPY&nbsp; &nbsp; </em></TD>
     <TD>Global index of the inflation spread in the lag smoother ensemble 
       handles (not currently used).</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->


 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="smoother_end"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call smoother_end() </em>
 <pre>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Releases storage allocated for smoother.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 </TABLE>
 <P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="smoother_inc_lags"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call smoother_inc_lags() </em>
 <pre>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Increments the number of lags that are in use for smoother. Used when
a smoother is being started up and there have not been enough times to
propagate the state to all requested lags.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 </TABLE>
 <P>
 <!--================================================================-->

<!--==================================================================-->


 <!--============== DESCRIPTION OF A NAMELIST ========================-->
 <A NAME="Namelist"></A>
 <BR><HR><BR>
 <P>We adhere to the F90 standard of starting a namelist with an ampersand
 '&' and terminating with a slash '/'.
 <div class=namelist><pre>
 <em class=call>namelist / smoother_nml / </em>
 num_lags,start_from_restart,output_restart,restart_in_file_name,
restart_out_file_name


 </pre></div>
 <H3 class=indent1>Discussion</H3>
 <P>

 </em>
 </P>
 <P>This namelist is read in a file called <em class=file>input.nml</em>
 </P>
 <TABLE border=0 cellpadding=3 width=100%>
 <TR><TH align=left>Contents    </TH>
     <TH align=left>Type        </TH>
     <TH align=left>Description </TH></TR>
 <TR><!--contents--><TD valign=top>num_lags</TD>
     <!--  type  --><TD>integer</TD>
 <!--descript--><TD>Number of smoother lags; < 1 means no smoother. Default: 0</TD></TR>
 <TR><!--contents--><TD valign=top>start_from_restart</TD>
     <!--  type  --><TD>logical</TD>
 <!--descript--><TD>True if smoother states are to come from restart file. False
  if they are to be spun up from scratch. Default: .false.</TD></TR>
 <TR><!--contents--><TD valign=top>output_restart</TD>
     <!--  type  --><TD>logical</TD>
 <!--descript--><TD>True if restart file is to be written, else false. 
   Default:.false.</TD></TR>
 <TR><!--contents--><TD valign=top>restart_in_file_name</TD>
     <!--  type  --><TD>character(len=129)</TD>
 <!--descript--><TD>File name from which to read restarts, lag extensions get added. 
       Default: smoother_ics </TD></TR>
 <TR><!--contents--><TD valign=top>restart_out_file_name</TD>
     <!--  type  --><TD>character(len=129)</TD>
 <!--descript--><TD>File name to which to write smoother restarts, lag extensions get added. 
    Default: smoother_restart</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->


<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<BR><HR><BR>
<H2>FILES</H2>
<UL><LI>input.nml</LI>
    <LI>smoother restart files with lag extensions</LI>
</UL>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR><BR>
<H2>REFERENCES</H2>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>smoother_generate_copy_meta_data</TD>
    <!-- message --><TD VALIGN=top>output metadata in smoother needs ensemble size < 10000, not ###</TD>
    <!-- comment --><TD VALIGN=top>Can't output more than 9999 copies.</TD>
</TR>
</TABLE>
</div>

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<BR><HR><BR>
<H2>KNOWN BUGS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Descibe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR><BR>
<H2>FUTURE PLANS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Have not fleshed out this part yet ... ha ha ha                  -->
<!--==================================================================-->

<A NAME="PrivateComponents"></A>
<BR><HR><BR>
<H2>PRIVATE COMPONENTS</H2>

<div class=routine>
<pre>
</div>

<H3 class=indent1>Discussion</H3>

<!--==================================================================-->

<HR>
</BODY>
</HTML>
