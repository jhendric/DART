<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<HTML>
<TITLE>module obs_def_kind</TITLE>
<link rel=stylesheet type=text/css href=../doc/html/doc.css>
<BODY>

<DIV ALIGN=CENTER>
<A HREF="#Interface">INTERFACE</A> / 
<A HREF="#PublicEntities">PUBLIC COMPONENTS</A> / 
<A HREF="#Namelist">NAMELIST</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A> /
</DIV>

<!--==================================================================-->

<H1>MODULE obs_kind_mod</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
   <TR><TD>Contact:       </TD><TD> Jeff Anderson                </TD></TR>
   <TR><TD>Reviewers:     </TD><TD> &nbsp;                       </TD></TR>
   <TR><TD>Revision:      </TD><TD> $Revision$             </TD></TR>
   <TR><TD>Release Name:  </TD><TD> $Name$                       </TD></TR>
   <TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
   <TR><TD>Change history:</TD><TD> see CVS log                  </TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>
<P>
Provides definitions of observation types and generic variable kinds and
tools for determining how to use observations available in an observation 
sequence file.

Generic kinds can be associated with an observation type or with a model
state variable. An example is U_WIND_COMPONENT. State variables in a model
can be associated with this generic kind. Similarly, many different observation
types can be associated with this generic kind, for instance 
RADIOSONDE_U_WIND_COMPONENT and ACARS_U_WIND_COMPONENT. Generic kinds are
defined via an integer parameter statement at the start of this module. As
new generic kinds are needed, they can be added to this list. Generic kind
integer parameters are required to start with KIND_ and observation types
are NOT allowed to start with KIND_.
</P>


<P>
Beginning with the I-release of DART, a more flexible. powerful (and complicated)
mechanism for incorporating new types of observations is part of DART. The
obs_kind module being described here is created by the program preprocess.f90
from two kinds of input files. First, a DEFAULT obs_kind module (normally called
DEFAULT_obs_kind_mod.F90 and documented in this directory) is used as a template
into which the preprocessor incorporates information from zero or more special
obs_def modules (such as obs_def_1d_state_mod.f90 or obs_def_reanalyis_bufr_mod.f90)
which are also documented in the obs_def directory. If no special obs_def files are 
included in the preprocessor namelist, a minimal obs_kind_mod.f90 is created which
can only support identity forward observation operators.
</P>

<P>
The obs_kind module contains a table, the obs_kind_info table, that 
defines the details of each observation type that has been created by the 
preprocess program. Each table entry contains the integer index of the
observation type which is associated with an integer parameter declaration.
Also associated with each table entry are the name of the observation type (
this string is identical to the F90 identifier associated with the
integer index via the parameter statement), the integer index of the 
associated associated generic kind, and two logicals indicating whether this
observation type is to be assimilated, evaluated only (forward operator is
computed but not assimilated), or ignored entirely. These logicals can be
set via the namelist and have defaults values that cause an observation
type to be ignored.
</P>

<P>
<BR>

<!--==================================================================-->

<A NAME="OTHER MODULES USED"></A>
<BR><HR><BR>
<H2>OTHER MODULES USED</H2>
<PRE>
utilities_mod
</PRE>

<!--==================================================================-->
<!--Note to authors. The first row of the table is different.         -->

<A NAME="Interface"></A>
<BR><HR><BR>
<H2>PUBLIC INTERFACE</H2>

<TABLE>
<TR><TD><em class=call>use obs_def_mod, only : </em></TD>
                   <TD><A HREF="#max_obs_kinds">max_obs_kinds</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_obs_kind_name">get_obs_kind_name</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#assimilate_this_obs_kind">assimilate_this_obs_kind</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#evaluate_this_obs_kind">evaluate_this_obs_kind</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_obs_kind_var_type">get_obs_kind_var_type</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_obs_kind_index">get_obs_kind_index</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#write_obs_kind">write_obs_kind</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#read_obs_kind">read_obs_kind</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_kind_from_menu">get_kind_from_menu</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#map_def_index">map_def_index</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#GENERIC_KIND_DEFINITIONS">GENERIC_KIND_DEFINITIONS</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#OBSERVATION_TYPES">OBSERVATION_TYPES</A></TD></TR>
</TABLE>

<BR>

<!--==================================================================-->
<!-- Declare all public entities ...                                  -->
<!-- duplicate public routines template as many times as necessary    -->
<!-- make sure you replace all yyyroutine?? strings                   -->
<!--==================================================================-->

<A NAME="PublicEntities"></A>
<BR><HR><BR>
<H2>PUBLIC COMPONENTS</H2>
<BR>

 <!--============= DESCRIPTION OF A FUNCTION ========================-->
 <A NAME="get_obs_kind_name"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> var = get_obs_kind_name(obs_kind_ind) </em>
 <pre>
 character(len=32), intent(out) :: <em class=code>get_obs_kind_name</em>
 integer, intent(in)            :: <em class=code>obs_kind_ind</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
 Given an integer index into the obs_kind_info table (the index is defined
 in the integer, parameter statement for the observation types that is
 created by the preprocess program (see DEFAULT_obs_kind_mod.html), returns
 the associated string name. This string is the same as the F90 identifier
 associated with the integer index.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>get_obs_kind_name&nbsp; &nbsp; </em></TD>
     <TD>Name string associated with this entry in the obs_kind_info table.</TD>
 </TR>
 <TR><TD valign=top><em class=code>obs_kind_ind&nbsp; &nbsp; </em></TD>
     <TD>An integer index into the obs_kind_info table.</TD></TR>
 </TABLE>
 <P>
 </P>
 <!--================================================================-->
 <!--============= DESCRIPTION OF A FUNCTION ========================-->
 <A NAME="assimilate_this_obs_kind"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> var = assimilate_this_obs_kind(obs_kind_ind) </em>
 <pre>
 logical, intent(out) :: <em class=code>assimilate_this_obs_kind</em>
 integer, intent(in)  :: <em class=code>obs_kind_ind</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
  Given an integer index into the obs_kind_info table (the index is defined
 in the integer, parameter statement for the observation types that is
 created by the preprocess program (see DEFAULT_obs_kind_mod.html), returns
 true if this observation type is to be assimilated, otherwise false.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>assimilate_this_obs_kind&nbsp; &nbsp; </em></
 TD>
     <TD>Returns true if this entry in the obs_kind_info table is to be assimila
 ted.</TD></TR>
 <TR><TD valign=top><em class=code>obs_kind_ind&nbsp; &nbsp; </em></TD>
     <TD>An integer index into the obs_kind_info table.</TD></TR>
 </TABLE>
 <P>
 </P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A FUNCTION ========================-->
 <A NAME="evaluate_this_obs_kind"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> var = evaluate_this_obs_kind(obs_kind_ind) </em>
 <pre>
 logical, intent(out) :: <em class=code>evaluate_this_obs_kind</em>
 integer, intent(in)  :: <em class=code>obs_kind_ind</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
  Given an integer index into the obs_kind_info table (the index is defined
 in the integer, parameter statement for the observation types that is
 created by the preprocess program (see DEFAULT_obs_kind_mod.html), returns
 true if this observation type is to be evaluated, otherwise false.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>evaluate_this_obs_kind&nbsp; &nbsp; </em></
 TD>
     <TD>Returns true if this entry in the obs_kind_info table is to be evaluated.</TD></TR>
 <TR><TD valign=top><em class=code>obs_kind_ind&nbsp; &nbsp; </em></TD>
     <TD>An integer index into the obs_kind_info table.</TD></TR>
 </TABLE>
 <P>
 </P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A FUNCTION ========================-->
 <A NAME="get_obs_kind_var_type"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> var = get_obs_kind_var_type(obs_kind_ind) </em>
 <pre>
 integer, intent(out) :: <em class=code>get_obs_kind_var_type</em>
 integer, intent(in)  :: <em class=code>obs_kind_ind</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
  Given an integer index into the obs_kind_info table (the index is defined
 in the integer, parameter statement for the observation types that is
 created by the preprocess program (see DEFAULT_obs_kind_mod.html), returns
 the integer index of the GENERIC KIND that is associated with this observation
 type.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>get_obs_kind_var_type&nbsp; &nbsp; </em></
 TD>
     <TD>Returns the integer GENERIC kind index associated with this obs type.</TD></TR>
 <TR><TD valign=top><em class=code>obs_kind_ind&nbsp; &nbsp; </em></TD>
     <TD>An integer index into the obs_kind_info table.</TD></TR>
 </TABLE>
 <P>
 </P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A FUNCTION ========================-->
 <A NAME="get_obs_kind_index"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> var = get_obs_kind_index(obs_kind_name) </em>
 <pre>
 integer, intent(out)          :: <em class=code>get_obs_kind_index</em>
 character(len=32), intent(in) :: <em class=code>obs_kind_name</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
 Given the name of an observation type, returns the index of the entry
 in the obs_kind_info table with this name. If the name is not found in
 the table, a -1 is returned. The integer returned for a successful
 search is the value of the integer parameter with the same identifier
 as the name string.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>get_obs_kind_index&nbsp; &nbsp; </em></TD>
     <TD>Integer index into the obs_kind_info table entry with name string corre
 sponding to obs_kind_name.</TD></TR>
 <TR><TD valign=top><em class=code>obs_kind_name&nbsp; &nbsp; </em></TD>
     <TD>Name of observation type to be found in obs_kind_info table.</TD></TR>
 </TABLE>
 <P>
 </P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="write_obs_kind"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call write_obs_kind(ifile,fform) </em>
 <pre>
 integer, intent(in)                    :: <em class=code>ifile</em>
 character(len=*), optional, intent(in) :: <em class=code>fform</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
 Writes out information about all defined observation types from the
obs_kind_info table. For each entry in the table, the integer index of
the observation type and the associated string are written. These
appear in the header of an obs_sequence file.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>ifile&nbsp; &nbsp; </em></TD>
     <TD>Unit number of output observation sequence file being written.</TD></TR
 >
 <TR><TD valign=top><em class=code>fform&nbsp; &nbsp; </em></TD>
     <TD>Optional format for file. Default is ascii.</TD></TR>
 </TABLE>
 <P>
 </P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="read_obs_kind"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call read_obs_kind(ifile,pre_I_format,fform) </em>
 <pre>
 integer, intent(in)                    :: <em class=code>ifile</em>
 logical, intent(in)                    :: <em class=code>pre_I_format</em>
 character(len=*), optional, intent(in) :: <em class=code>fform</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
 Reads the mapping between integer indices and observation type names
 from the header of an observation sequence file and prepares mapping
 to convert these to values defined in the obs_kind_info table. If
 pre_I_format is true, there is no header in the observation sequence
file and it is assumed that the integer indices for observation types
in the file correspond to the storage order of the obs_kind_info table
(integer index 1 in the file corresponds to the first table entry, etc.)
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>ifile&nbsp; &nbsp; </em></TD>
     <TD>>Unit number of output observation sequence file being written.</TD></T
 R>
 <TR><TD valign=top><em class=code>pre_I_format&nbsp; &nbsp; </em></TD>
     <TD>True if the file being read has no obs type definition header.</TD></TR
 >
 <TR><TD valign=top><em class=code>fform&nbsp; &nbsp; </em></TD>
     <TD>Optional format for file. Default is ascii.</TD></TR>
 </TABLE>
 <P>
 </P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A FUNCTION ========================-->
 <A NAME="get_kind_from_menu"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> var = get_kind_from_menu() </em>
 <pre>
 integer, intent(out) :: <em class=code>get_kind_from_menu</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
 Interactive input of observation type from the obs_kind info.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>get_kind_from_menu&nbsp; &nbsp; </em></TD>
     <TD>Integer index of observation type.</TD></TR>
 </TABLE>
 <P>
 </P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A FUNCTION ========================-->
 <A NAME="map_def_index"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> var = map_def_index(obs_def_index) </em>
 <pre>
 integer, intent(out) :: <em class=code>map_def_index</em>
 integer, intent(in)  :: <em class=code>obs_def_index</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
 Maps from the integer observation type index in the header block of
 an input observation sequence file into the corresponding entry in
 the obs_kind_info table. This allows observation sequences that were
 created with different obs_kind_mod.f90 versions to be used with
 the current obs_kind_mod.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>map_def_index&nbsp; &nbsp; </em></TD>
     <TD>Index of this observation type in obs_kind_info table.</TD></TR>
 <TR><TD valign=top><em class=code>obs_def_index&nbsp; &nbsp; </em></TD>
     <TD>Index of observation type from input observation sequence file.</TD></T
 R>
 </TABLE>
 <P>
 </P>
 <!--================================================================-->

 <!--===================== DESCRIPTION OF PUBLIC VARIABLE =====================-->

<A NAME="max_obs_kinds"></A>
<P></P><HR><P></P>
<div class=routine>
<em class=call>integer, parameter :: max_obs_kinds </em>
<pre>
</pre></div>

<H2 class=indent1>Description</H2>

<P>
The total number of available observation types in the obs_kind_info table.
This value is added by the preprocess program. 
</P>


<BR>

<!--================================================================-->

<!--===================== DESCRIPTION OF PUBLIC VARIABLE =====================-->

<A NAME="GENERIC_KIND_DEFINITIONS"></A>
<P></P><HR><P></P>
<div class=routine>
<em class=call>integer, parameter :: KIND_..... </em>
<pre>
</pre></div>

<H2 class=indent1>Description</H2>

<P>
All generic kinds available are public parameters that begin with KIND_.
</P>


<BR>

<!--================================================================-->

<!--===================== DESCRIPTION OF PUBLIC VARIABLE =====================-->

<A NAME="OBSERVATION_TYPES"></A>
<P></P><HR><P></P>
<div class=routine>
<em class=call>integer, parameter :: SAMPLE_OBS_TYPE </em>
<pre>
</pre></div>

<H2 class=indent1>Description</H2>

<P>
A list of all observation types that are available is provided as
a set of integer parameter statements. The F90 identifiers are the
same as the string names that are associated with this identifier
in the obs_kind_info table.
</P>


<BR>

 <!--================================================================-->

 <!--============== DESCRIPTION OF A NAMELIST ========================-->
 <A NAME="Namelist"></A>
 <BR><HR><BR>
 <P>We adhere to the F90 standard of starting a namelist with an ampersand
 '&' and terminating with a slash '/'.
 <div class=namelist><pre>
 <em class=call>namelist / obs_kind_nml / </em>
 assimilate_these_obs_types,evaluate_these_obs_types



 </pre></div>
 <H3 class=indent1>Discussion</H3>
 <P>
 Controls what observation types are to be assimilated, evaluated, or
 ignored. For each entry, a list of observation type names can be
 specified. Any name in the obs_kind_info table is eligible. Specifying
 a name that is not in the table results in an error. Specifying the
 same name for both namelist entries also results in an error.
 Observation types specified in the list for assimilate_these_obs_types
 are assimilated. Those in the evaluate_these_obs_types list have
 their forward operators computed and included in diagnostic files but
 are not assimilated. An observation type that is specified in neither
 list is ignored.  Identity observations, however, are always assimilated
 if present in the obs_seq.out file.
 </em>
 </P>
 <P>This namelist is read in a file called <em class=file>input.nml</em>
 </P>
 <TABLE border=0 cellpadding=3 width=100%>
 <TR><TH align=left>Contents    </TH>
     <TH align=left>Type        </TH>
     <TH align=left>Description </TH></TR>
 <TR><!--contents--><TD valign=top>assimilate_these_obs_types</TD>
     <!--  type  --><TD>character(len=129)</TD>
 <!--descript--><TD>Name of observation type to be assimilated only. Default: null</TD></TR>
 <TR><!--contents--><TD valign=top>evaluate_these_obs_types</TD>
     <!--  type  --><TD>character(len=129)</TD>
 <!--descript--><TD>Name of observation type to be evaluated only. Default: null
 </TD></TR>
 </TABLE>
 <P>
 </P>
 <!--================================================================-->

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->
</P>
<A NAME="FilesUsed"></A>
<BR><HR><BR>
<H2>FILES</H2>
<UL>
<LI>obs_kind_nml in input.nml
<LI>Files containing input or output observation sequences.
</UL>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR><BR>
<H2>REFERENCES</H2>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>initialize_module</TD>
    <!-- message --><TD VALIGN=top>______ from obs_kind_nml is not a legal observation kind</TD>
    <!-- comment --><TD VALIGN=top>An observation type  name that is not in the 
    obs_kind_info table has been specified to be assimilated or evaluted.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>initialize_module</TD>
    <!-- message --><TD VALIGN=top>Illegal to evaluate and assimilate the same kind ______</TD>
    <!-- comment --><TD VALIGN=top>The same observation type name has been specified in 
                                 both namelist entries.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>map_def_index</TD>
    <!-- message --><TD VALIGN=top>Couldnt find obs_def_index __ in obs_kind map.</TD>
    <!-- comment --><TD VALIGN=top>An attempt to use an observation type that was NOT
                                   in the obs_sequence header.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>read_obs_kind</TD>
    <!-- message --><TD VALIGN=top>Didnt find obs_kind_definition string</TD>
    <!-- comment --><TD VALIGN=top>An obs_sequence file that was expected to contain
              an obs_kind_definition list in its header did not. </TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>read_obs_kind</TD>
    <!-- message --><TD VALIGN=top>didnt find observation kind _____ in obs_kind_mod list</TD>
    <!-- comment --><TD VALIGN=top> An observation type specified by name in an observation 
               sequence file header was NOT found in the obs_kind_info table. </TD>
</TR>

</TABLE>
</div>

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<BR><HR><BR>
<H2>KNOWN BUGS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Describe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR><BR>
<H2>FUTURE PLANS</H2>
<P>
</P>

<!--==================================================================-->

<HR>
</BODY>
</HTML>
