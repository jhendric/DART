<HTML>
<HEAD>
<TITLE>program filter</TITLE>
<link rel="stylesheet" type="text/css" href="../doc/html/doc.css"></link> 
</HEAD>
<BODY>
<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<DIV ALIGN=CENTER>
<A HREF="#PublicEntities">PUBLIC COMPONENTS</A> / 
<A HREF="#Namelist">NAMELIST</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A> /
<A HREF="#PrivateComponents">PRIVATE COMPONENTS</A>
</DIV>

<!--==================================================================-->

<H1>PROGRAM filter</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
<TR><TD>Contact:       </TD><TD> Jeff Anderson     </TD></TR>
<TR><TD>Revision:      </TD><TD> $Revision$ </TD></TR>
<TR><TD>Source:        </TD><TD> $URL$ </TD></TR>
<TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
<TR><TD>Change history:</TD><TD> try "svn log" or "svn diff" </TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>

<P>
   Main program for driving ensemble filter assimilations. 
</P>

<P> This program 
   provides a number of options that are driven from its namelist. The
   number of assimilation steps to be done are controlled by the input
   observation sequence and by the time-stepping capabilities of the model
   being used in the assimilation. This documentation was created for the
   J-release of DART.
</P>

<P>
   The filter adds a quality control field with metadata 'DART quality control'
   to the obs_seq.final file. At present, this field can have the following
   values: 
 <TABLE border=0 cellpadding=3 width=100%>
    <TR><TD>0:</TD><TD> Observation is okay </TD></TR>
    <TR><TD>1:</TD><TD> Observation was evaluated only but not
       used in the assimilation </TD></TR>
    <TR><TD>2:</TD><TD> The observation was used but one or more of
       the posterior forward observation operators failed </TD></TR>
    <TR><TD>3:</TD><TD> The observation
       was evaluated only but not used AND one or more of the posterior 
       forward observation operators failed </TD></TR>
    <TR><TD>4:</TD><TD> One or more prior forward observation
       operators failed so the observation was not used </TD></TR>
    <TR><TD>5:</TD><TD> The observation was
       not used because it was not selected in the namelist to be assimilated
       or evaluated </TD></TR>
    <TR><TD>6:</TD><TD> The prior quality control value was too high so the
       observation was not used.  </TD></TR>
    <TR><TD>7:</TD><TD> Outlier test failed (see below)</TR>
  </TABLE>
</P>

<P>
   The filter also can perform an outlier threshold test on observations. If
   the prior ensemble mean differs from the observed value by more than a
   specified number of standard deviations, it is not used and the DART
   quality control field is set to 7.
</P>

<P>
Optional namelist interface
<A HREF="#Namelist"> <em class=code>&#38;filter_nml</em> </A>
may be read from file <em class=file>input.nml</em>.
</P>

<!--==================================================================-->

<A NAME="OTHER MODULES USED"></A>
<HR>
<H2>OTHER MODULES USED</H2>
<PRE>
types_mod
obs_sequence_mod
obs_def_mod
time_manager_mod
utilities_mod
assim_model_mod
assim_tools_mod
obs_model_mod
ensemble_manager_mod
adaptive_inflate_mod
mpi_utilities_mod
smoother_mod
</PRE>


<!--==================================================================-->

<!--============== DESCRIPTION OF A NAMELIST ========================-->
 <A NAME="Namelist"></A>
 <HR>
 <H2>NAMELIST</H2>
 <P>We adhere to the F90 standard of starting a namelist with an ampersand
 '&#38;' and terminating with a slash '/'.
 <div class=namelist><pre>
 <em class=call>namelist / filter_nml / </em>
   async,
   adv_ens_command,
   ens_size,
   start_from_restart,
   output_restart,
   obs_sequence_in_name,
   obs_sequence_out_name,
   restart_in_file_name,
   restart_out_file_name,
   init_time_days,
   init_time_seconds,
   first_obs_days,
   first_obs_seconds,
   last_obs_days,
   last_obs_seconds,
   num_output_state_members,
   num_output_obs_members,
   output_interval,
   num_groups,
   input_qc_threshold,
   outlier_threshold,
   output_forward_op_errors,
   output_timestamps,
   output_inflation,
     
   inf_flavor,
   inf_start_from_restart,
   inf_output_restart,
   inf_deterministic,
   inf_in_file_name,
   inf_out_file_name,
   inf_diag_file_name,
   inf_initial,
   inf_sd_initial,
   inf_lower_bound,
   inf_upper_bound,
   inf_sd_lower_bound
 </pre></div>
 <H3 class=indent1>Discussion</H3>
 <P>
Controls various aspects of filter. The inflation control variables are all
dimensioned 2, the first value being for the prior inflation and the second
being for the posterior inflation.
 </em>
 </P>
 <P>This namelist is read in a file called <em class=file>input.nml</em>
 </P>
 <TABLE border=0 cellpadding=3 width=100%>
 <TR><TH align=left>Contents    </TH>
     <TH align=left>Type        </TH>
     <TH align=left>Description </TH></TR>

 <TR><!--contents--><TD valign=top>async</TD>
     <!--  type  --><TD>integer</TD>
     <!--descript--><TD>Controls method for advancing model: 
                        0&nbsp;is&nbsp;subroutine&nbsp;call, 
                        2&nbsp;is&nbsp;shell&nbsp;command. 
                        Default: 0</TD></TR>

 <TR><!--contents--><TD valign=top>adv_ens_command</TD>
     <!--  type  --><TD>character(len=129)</TD>
     <!--descript--><TD>Command sent to shell if async is 2. 
                        Default: ./advance_model.csh</TD></TR>

 <TR><!--contents--><TD valign=top>ens_size</TD>
     <!--  type  --><TD>integer</TD>
     <!--descript--><TD>Size of ensemble.
                        Default: 20</TD></TR>

 <TR><!--contents--><TD valign=top>start_from_restart</TD>
     <!--  type  --><TD>logical</TD>
     <!--descript--><TD>True means start from a restart file, false means 
                        perturb a single state vector in restart file. 
                        Default: .false.</TD></TR>

 <TR><!--contents--><TD valign=top>output_restart</TD>
     <!--  type  --><TD>logical</TD>
     <!--descript--><TD>True means output a restart file. 
                        Default: .false.</TD></TR>

 <TR><!--contents--><TD valign=top>obs_sequence_in_name</TD>
     <!--  type  --><TD>character(len=129)</TD>
     <!--descript--><TD>File name from which to read an observation sequence. 
                        Default: obs_seq.out</TD></TR>

 <TR><!--contents--><TD valign=top>obs_sequence_out_name</TD>
     <!--  type  --><TD>character(len=129)</TD>
     <!--descript--><TD>File name to which to write output observation sequence. 
                        Default: obs_seq.final</TD></TR>

 <TR><!--contents--><TD valign=top>restart_in_file_name</TD>
     <!--  type  --><TD>character(len=129)</TD>
     <!--descript--><TD>File containing state restart vectors. 
                        Default: filter_ics</TD></TR>

 <TR><!--contents--><TD valign=top>restart_out_file_name</TD>
     <!--  type  --><TD>character(len=129)</TD>
     <!--descript--><TD>File to which to write restart state vectors. 
                        Default: filter_restart</TD></TR>

 <TR><!--contents--><TD valign=top>init_time_days</TD>
     <!--  type  --><TD>integer</TD>
     <!--descript--><TD>If negative, don't use. If non-negative, override the initial 
                        days read from state restart. 
                        Default: 0</TD></TR>

 <TR><!--contents--><TD valign=top>init_time_seconds</TD>
     <!--  type  --><TD>integer</TD>
     <!--descript--><TD>If negative don't use. If non-negative, override the initial
                        seconds read from state restart. 
                        Default: 0</TD></TR>

 <TR><!--contents--><TD valign=top>num_output_state_members</TD>
     <!--  type  --><TD>integer</TD>
     <!--descript--><TD>Number of ensemble members to be included in the state 
                        diagnostic output. Default: 0</TD></TR>

 <TR><!--contents--><TD valign=top>num_output_obs_members</TD>
     <!--  type  --><TD>integer</TD>
     <!--descript--><TD>Number of ensemble members to be included in the 
                        observation sequence file. Default: 0</TD></TR>

 <TR><!--contents--><TD valign=top>output_interval</TD>
     <!--  type  --><TD>integer</TD>
     <!--descript--><TD>Output state and observation diagnostics every 'N'th 
                        assimilation time, N is output_interval. Default: 1</TD></TR>

 <TR><!--contents--><TD valign=top>num_groups</TD>
     <!--  type  --><TD>integer</TD>
     <!--descript--><TD>Number of groups for hierarchical filter. Default: 1</TD></TR>

 <TR><!--contents--><TD valign=top>outlier_threshold</TD>
     <!--  type  --><TD>real(r8)</TD>
     <!--descript--><TD>Reject observation if prior mean is more than this many 
                        sd's from observation. Negative means no check. 
                        Default: -1.0_r8</TD></TR>

 <TR><!--contents--><TD valign=top>input_qc_threshold</TD>
     <!--  type  --><TD>real(r8)</TD>
     <!--descript--><TD>Reject observation if incoming QC value exceeds
                        'input_qc_threshold' value. Incoming observations have a
                        QC value (usually set by NCEP). 
                        Default: 4.0_r8</TD></TR>

 <TR><!--contents--><TD valign=top>output_forward_op_errors</TD>
     <!--  type  --><TD>logical</TD>
     <!--descript--><TD>True means output errors from forward observation operators.
                        Default: .false.</TD></TR>

 <TR><!--contents--><TD valign=top>output_timestamps</TD>
     <!--  type  --><TD>logical</TD>
     <!--descript--><TD>True means output timestamps before and after the model advance
                        and the observation assimilation phases.
                        Default: .false.</TD></TR>

 <TR><!--contents--><TD valign=top>output_inflation</TD>
     <!--  type  --><TD>logical</TD>
     <!--descript--><TD>True means output inflation values in the prior and posterior
                        diagnostic files.  False omits them.
                        Default: .true.</TD></TR>

 <TR><TD colspan=3>All subsequent variables are arrays of length 2.<br>
                   The first element is for the prior, the second element is 
                   for the posterior</TD></TR>

 <TR><!--contents--><TD valign=top>inf_flavor</TD>
     <!--  type  --><TD>integer array (len=2)</TD>
     <!--descript--><TD>Inflation flavor for [prior, posterior]<br>
                        0&nbsp;=&nbsp;none,
                        1&nbsp;=&nbsp;obs_space, 
                        2&nbsp;=&nbsp;varying&nbsp;state&nbsp;space,
                        3&nbsp;=&nbsp;fixed&nbsp;state&nbsp;space. 
                        Default: (/0, 0/)</TD></TR>

 <TR><!--contents--><TD valign=top>inf_start_from_restart</TD>
     <!--  type  --><TD>logical array (len=2)</TD>
     <!--descript--><TD>If true, get initial values for inflation from restart file.
                        Default: (/.false., .false /)</TD></TR>

 <TR><!--contents--><TD valign=top>inf_output_restart</TD>
     <!--  type  --><TD>logical array (len=2)</TD>
     <!--descript--><TD>Output an inflation restart file if true. 
                        Default: (/.false., .false./)</TD></TR>

 <TR><!--contents--><TD valign=top>inf_deterministic</TD>
     <!--  type  --><TD>logical array (len=2)</TD>
     <!--descript--><TD>True means determinstic inflation, false means stochastic. 
                        Default: (/.true., .true./)</TD></TR>

 <TR><!--contents--><TD valign=top>inf_in_file_name</TD>
     <!--  type  --><TD>character(len=129) by two</TD>
     <!--descript--><TD>Name from which to read inflation restart. 
                        Default: (/'not_initialized', 'not_initialized'/)</TD></TR>

 <TR><!--contents--><TD valign=top>inf_out_file_name</TD>
     <!--  type  --><TD>character(len=129) by two</TD>
     <!--descript--><TD>File to which to write inflation restart file. 
                        Default: (/'not_initialized', 'not_initialized'/)</TD></TR>

 <TR><!--contents--><TD valign=top>inf_diag_file_name</TD>
     <!--  type  --><TD>character(len=129) by two</TD>
     <!--descript--><TD>File to which to write output diagnostics for observation 
                        space inflation. 
                        Default: (/'not_initialized', 'not_initialized'/)</TD></TR>

 <TR><!--contents--><TD valign=top>inf_initial</TD>
     <!--  type  --><TD>real(r8) (len=2)</TD>
     <!--descript--><TD>Initial value of inflation if not read from restart file. 
                        Default: (/1.0_r8, 1.0_r8/)</TD></TR>

 <TR><!--contents--><TD valign=top>inf_sd_initial</TD>
     <!--  type  --><TD>real(r8) (len=2)</TD>
     <!--descript--><TD>Initial value of inflation standard deviation if not read 
                        from restart file.
                        Default: (/0.0_r8, 0.0_r8/)</TD></TR>

 <TR><!--contents--><TD valign=top>inf_lower_bound</TD>
     <!--  type  --><TD>real(r8) (len=2)</TD>
     <!--descript--><TD>Lower bound for inflation value.
                        Default: (/1.0_r8, 1.0_r8/)</TD></TR>

 <TR><!--contents--><TD valign=top>inf_upper_bound</TD>
     <!--  type  --><TD>real(r8) (len=2)</TD>
     <!--descript--><TD>Upper bound on inflation value.
                        Default: (/1000000.0_r8, 1000000.0_r8/)</TD></TR>

 <TR><!--contents--><TD valign=top>inf_sd_lower_bound</TD>
     <!--  type  --><TD>real(r8) (len=2)</TD>
     <!--descript--><TD>Lower bound for inflation standard deviation. 
                        Default: (/0.0_r8, 0.0_r8/)</TD></TR>
 </TABLE>

 <H4 class=indent1>Deprecated or Defunct namelist variables</H4>
 <P>The following table contains the deprecated or defunct namelist variables.
    It is a FATAL ERROR to have these in the filter namelist.
 </P>
 <TABLE border=0 cellpadding=3 width=100%>
 <TR><TH align=left>Contents    </TH>
     <TH align=left>Type        </TH>
     <TH align=left>Description </TH></TR>

 <TR><!--contents--><TD valign=top>output_state_ens_mean</TD>
     <!--  type  --><TD><b>defunct</b></TD>
     <!--descript--><TD>The ensemble mean is now always in the 
                        state diagnostic output.</TD></TR>

 <TR><!--contents--><TD valign=top>output_state_ens_spread</TD>
     <!--  type  --><TD><b>defunct</b></TD>
     <!--descript--><TD>The ensemble spread is now always in the
                        state diagnostic output.</TD></TR>

 <TR><!--contents--><TD valign=top>output_obs_ens_mean</TD>
     <!--  type  --><TD><b>defunct</b></TD>
     <!--descript--><TD>The ensemble mean is now always in the 
                        output observation sequence file.</TD></TR>

 <TR><!--contents--><TD valign=top>output_obs_ens_spread</TD>
     <!--  type  --><TD><b>defunct</b></TD>
     <!--descript--><TD>The ensemble spread is now always in the 
                        output observation sequence file.</TD></TR>
 </TABLE>

 <P>
 <!--================================================================-->



<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<HR>
<H2>FILES</H2>
<UL><LI>observation sequence input file; from obs_sequence_in_name
    <LI>output state space prior diagnostics file; Prior_Diag.nc
    <LI>output state space posterior diagnostics file; Posterior_Diag.nc
    <LI>output observation space diagnostic file; from obs_sequence_out_name
    <LI>filter.nml in input.nml
</UL>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<HR>
<H2>REFERENCES</H2>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>filter_main</TD>
    <!-- message --><TD VALIGN=top>ens_size in namelist is ###: Must be > 1</TD>
    <!-- comment --><TD VALIGN=top>Ensemble size must be at least 2. </TD>

<TR><!-- routine --><TD VALIGN=top>filter_main</TD>
    <!-- message --><TD VALIGN=top>inf_flavor= ### Must be 0, 1, 2, 3.</TD>
    <!-- comment --><TD VALIGN=top>Only inflation options 0 to 3 are supported. </TD>

<TR><!-- routine --><TD VALIGN=top>filter_main</TD>
    <!-- message --><TD VALIGN=top>Posterior observation space inflation (type 1) not supported.</TD>
    <!-- comment --><TD VALIGN=top>Posterior observation space inflation doesn't work. </TD>

<TR><!-- routine --><TD VALIGN=top>filter_main</TD>
    <!-- message --><TD VALIGN=top>Number of processes > model size.</TD>
    <!-- comment --><TD VALIGN=top>Number of processes can't exceed model size for now. </TD>

<TR><!-- routine --><TD VALIGN=top>filter_generate_copy_meta_data</TD>
    <!-- message --><TD VALIGN=top>output metadata in filter needs state ensemble size < 10000, not ###.</TD>
    <!-- comment --><TD VALIGN=top>Only up to 10000 ensemble members with state output for now. </TD>

<TR><!-- routine --><TD VALIGN=top>filter_generate_copy_meta_data</TD>
    <!-- message --><TD VALIGN=top>output metadata in filter needs obs ensemble size < 10000, not ###.</TD>
    <!-- comment --><TD VALIGN=top>Only up to 10000 ensemble members with obs space output for now. </TD>

<TR><!-- routine --><TD VALIGN=top>filter_setup_obs_sequence</TD>
    <!-- message --><TD VALIGN=top>input obs_seq file has ### qc fields; must be < 2.</TD>
    <!-- comment --><TD VALIGN=top>Only 0 or 1 qc fields in input obs sequence for now. </TD>

<TR><!-- routine --><TD VALIGN=top>get_obs_copy_index</TD>
    <!-- message --><TD VALIGN=top>Did not find observation copy with metadata observation.</TD>
    <!-- comment --><TD VALIGN=top>Only 0 or 1 qc fields in input obs sequence for now. </TD>


</TR>
</TR>

</TABLE>
</div>

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<HR>
<H2>KNOWN BUGS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Descibe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<HR>
<H2>FUTURE PLANS</H2>
<P>
Further development to better support observations that can only be
computed once is needed.
</P>

<!--==================================================================-->
<!-- Have not fleshed out this part yet ... ha ha ha                  -->
<!--==================================================================-->


<H3 class=indent1>Discussion</H3>

<!--==================================================================-->

<HR>
</BODY>
</HTML>
