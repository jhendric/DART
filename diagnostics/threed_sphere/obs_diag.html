<HTML>
<HEAD>
<TITLE>program obs_diag</TITLE>
<link rel="stylesheet" type="text/css" href="../../doc/html/doc.css"></link> 
</HEAD>
<BODY>
<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<DIV ALIGN=CENTER>
<A HREF="#Modules">MODULES</A> / 
<A HREF="#Namelist">NAMELIST</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#Usage">USAGE </A> / 
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A> /
<A HREF="#PrivateComponents">PRIVATE COMPONENTS</A>
</DIV>

<!--==================================================================-->

<H1>PROGRAM obs_diag</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
<TR><TD>Contact:       </TD><TD> Tim Hoar, Hui Liu  </TD></TR>
<TR><TD>Revision:      </TD><TD> $Revision$ </TD></TR>
<TR><TD>Source:        </TD><TD> $URL$ </TD></TR>
<TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
<TR><TD>Change history:</TD><TD> try "svn log" or "svn diff" </TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>

<P>
   Main program for evaluating filter performance in observation space. 
   That is, the models expected observations are compared against the actual
   observations in various ways.  
   <BR>
   <BR>
   Identity observations are already explored with state-space diagnostics,
   so <em class=program>obs_diag </em> simply skips them.
   <BR>
   <BR>
   It produces matlab-compatible text files for each observation kind 
   (i.e. RADIOSONDE, ACARS, ...), for each variable (i.e. T, WIND, ...), for
   domains specified in the <em class=code>obs_diag</em> namelist.
   The text files contain:
   <UL>
       <LI> time series of RMS error and spread (at a specified vertical level) 
            for Prior and Posterior fields (separately),
       <LI> vertical profiles of RMS error and bias averaged over 
	    specified assimilation times,
       <LI> time series and profiles of numbers of observations used,
   </UL>
   These data files can then be loaded and displayed using the 
   Matlab&#174; scripts in 
   <em class=file>.../DART/diagnostics/matlab</em>
   (or, in some cases, <em class=file>.../DART/matlab</em>).
</P>

<P>There are two versions of this program, one for high-order models that have
   real observations and another for low-order models. Since this program
   is fundamentally interested in the response as a function of region, the 
   division was made if the model has a threed_sphere or a oned 
   <em class=file>location_mod.f90</em>. It did not make sense to ask the 
   <em class=program>lorenz_96</em> model what part of North America you'd like
   to investigate.
   This program provides a number of options that are driven from its namelist. 
   <BR><BR>
   With the post-iceland release of DART, <em class=program>obs_diag</em> can 
   also handle observations on (up to 10) model levels. 
   Good luck getting observations on model levels.
</P>

<P>
   The <em class=program>obs_diag</em> program performs an outlier test on 
   observations, which can be more restrictive than the outlier test in the 
   filter, but not less 
   (see <em class=code>outlier_threshold</em> in <em class=code>filter_nml</em> 
   and <em class=code>rat_cri</em> here).
</P>

<P><em class='new'>
   The J release of DART also implements a DART QC flag that provides
   information about how the observation was or was not assimilated.
   The DART QC flag is intended to provide information about whether the
   observation was assimilated, evaluated only, whether the assimilation resulted
   in a 'good' observation, etc. Here is the table that should explain things: </em>
</P> 

<table width="80%">
   <tr><th align="left">DART QC flag value</th><th align="left">meaning</th></tr>
   <tr><td>0</td><td>observation assimilated</td></tr>
   <tr><td>1</td><td>observation evaluated only</td></tr>

   <tr><th align="left" colspan=2>DART QC values higher than this means the prior and posterior are OK, but ...</th></tr>

   <tr><td>2</td><td>assimilated, but the posterior forward operator failed</td></tr>
   <tr><td>3</td><td>Evaluated only, but the posterior forward operator failed</td></tr>

   <tr><th align="left" colspan=2>DART QC values higher than this means only the prior is OK, but ...</th></tr>

   <tr><td>4</td><td>prior forward operator failed</td></tr>
   <tr><td>5</td><td>not used because of namelist control</td></tr>

   <tr><th align="left" colspan=2>DART QC values higher than this are bad news.</th></tr>

   <tr><td>6</td><td>prior QC rejected</td></tr>
   <tr><td>7</td><td>outlier rejected</td></tr>
   <tr><td>8+</td><td>reserved for future use</td></tr>
</table>

<P>
   Optional namelist interface
   <A HREF="#Namelist"><em class=code>&#38;obs_diag_nml</em></A>
   may be read from file <em class=file>input.nml</em>.
</P>

<!--==================================================================-->

<A NAME="Modules"></A>
<BR><HR><BR>
<H2>OTHER MODULES USED</H2>
<PRE>
obs_sequence_mod
obs_kind_mod
obs_def_mod (and possibly other obs_def_xxx mods)
assim_model_mod
random_seq_mod
random_nr_mod
model_mod
location_mod
types_mod
time_manager_mod
utilities_mod
</PRE>


<!--==================================================================-->
<!--=================== DESCRIPTION OF A NAMELIST  ===================-->

<A NAME="Namelist"></A>
<BR><HR><BR>
<H2>NAMELIST</H2>
<P>We adhere to the F90 standard of starting a namelist with an 
   ampersand '&#38;' and terminating with a slash '/'.
   <div class=namelist><pre>
   <em class=call>namelist / obs_diag_nml / </em> &#38;
      obs_sequence_name, first_bin_center, last_bin_center, &#38;
      bin_separation, bin_width, time_to_skip, max_num_bins, &#38;
      plevel, hlevel, <em class=changed>mlevel</em>, obs_select, rat_cri, <em class=changed>input_qc_threshold</em>, &#38;
      Nregions, lonlim1, lonlim2, latlim1, latlim2, &#38;
      reg_names, print_mismatched_locs, print_obs_locations, verbose
   </pre></div>
</P>

<H3 class=indent1>Discussion</H3>

<P>This namelist is read in a file called <em class=file>input.nml</em>. <BR>
   The date-time integer arrays in this namelist have the form 
   (YYYY,&nbsp;MO,&nbsp;DA,&nbsp;HR,&nbsp;MIN,&nbsp;SEC). <BR>
   The allowable ranges for the region boundaries are: latitude [-90.,90], 
   longitude [0.,360.]
</P>


<TABLE border=0 cellpadding=3 width=100%>
<TR><TH align=left>Contents    </TH>
    <TH align=left>Type        </TH>
    <TH align=left>Description </TH></TR>

<TR><!--contents--><TD valign=top>   obs_sequence_name </TD>
    <!--  type  --><TD valign=top>   character         </TD>
    <!--descript--><TD>Name of the obs files in subdirectories. <BR>
	    Default 'obs_seq.final'</TD></TR>  

<TR><!--contents--><TD valign=top>   first_bin_center </TD>
    <!--  type  --><TD valign=top>  integer, dimension(6) </TD>
    <!--descript--><TD>first timeslot of the first obs_seq.final file to process.
	    The six integers are: year, month, day, hour, hour, minute, 
	    second -- in that order<BR>
            Default: 2003, 1, 1, 0, 0, 0</TD></TR>  

<TR><!--contents--><TD valign=top>   last_bin_center  </TD>
    <!--  type  --><TD valign=top>  integer, dimension(6) </TD>
    <!--descript--><TD>last timeslot of interest.
	    (reminder: the last timeslot of day 1 is hour 0 of day 2) 
	    The six integers are: year, month, day, hour, hour, minute, 
	    second -- in that order<BR>
            Default: 2003, 1, 2, 0, 0, 0</TD></TR>  

<TR><!--contents--><TD valign=top>   bin_separation       </TD>
    <!--  type  --><TD valign=top>  integer, dimension(6) </TD>
    <!--descript--><TD>Time between bin centers.
	    The year and month values <em>must</em> be zero.<BR>
            Default: 0, 0, 0, 6, 0, 0</TD></TR>  

<TR><!--contents--><TD valign=top>   bin_width        </TD>
    <!--  type  --><TD valign=top>  integer, dimension(6) </TD>
    <!--descript--><TD>Time span around bin centers in which obs will be 
	    compared.  The year and month values <em>must</em> be zero. 
	    Frequently, but not required to be, the same as the values 
	    for bin_separation.<BR>
            Default: 0, 0, 0, 6, 0, 0</TD></TR>  

<TR><!--contents--><TD valign=top>   time_to_skip     </TD>
    <!--  type  --><TD valign=top>  integer, dimension(6) </TD>
    <!--descript--><TD>Time span at the beginning to skip when calculating 
	    vertical profiles of rms error and bias. The year and month 
	    values <em>must</em> be zero. Useful because it takes some 
	    time for the assimilation to settle down from the climatological 
	    spread at the start.<BR>
            Default: 0, 0, 1, 0, 0, 0</TD></TR>  

<TR><!--contents--><TD valign=top>   max_num_bins  </TD>
    <!--  type  --><TD valign=top>   integer       </TD>
    <!--descript--><TD>For dimensioning arrays to accommodate your 
	    assimilation timeslots.<BR>
            Default: 1000000</TD></TR>  

<TR><!--contents--><TD valign=top>   plevel     </TD>
    <!--  type  --><TD valign=top>   integer    </TD>
    <!--descript--><TD>The RMS error, spread, and number of observations at 
	    this pressure (hPa) will be calculated.<BR>
            Default: 500</TD></TR>  

<TR><!--contents--><TD valign=top>   hlevel     </TD>
    <!--  type  --><TD valign=top>   integer    </TD>
    <!--descript--><TD>Same, but for observations that have height(m) as the 
	    vertical coordinate.<BR>
            Default: 5000</TD></TR>  

<TR><!--contents--><TD valign=top>   mlevel     </TD>
    <!--  type  --><TD valign=top>   integer    </TD>
    <!--descript--><TD>Observations on model level (perfect model observations)
	    at which the rms error, spread, and num_obs time series will 
	    be calculated.<BR>
            Default: 5</TD></TR>  

<TR><!--contents--><TD valign=top>   obs_select </TD>
    <!--  type  --><TD valign=top>   integer    </TD>
    <!--descript--><TD>Which obs subset to use; all(1), radiosonde only(2),
	    everything but radiosondes(3).<BR>
            Default: 1</TD></TR>  

<TR><!--contents--><TD valign=top>   rat_cri    </TD>
    <!--  type  --><TD valign=top>   real       </TD>
    <!--descript--><TD>Critical ratio of distance of the value of observation 
	    from the ensemble mean to the standard deviation of the 
	    ensemble.
	    Since we don't have all the ensemble members (in general) we cannot
	    calculate the covariance term that should be in the denominator, 
	    so it is not really the normalized distance<br>
	    abs(prior_mean - obsval) / sqrt( prior_spread + obs error variance)<br>
	    abs(prior_mean&nbsp;-&nbsp;obsval)&nbsp;/&nbsp;sqrt(&nbsp;prior_spread&nbsp;+&nbsp;obs&nbsp;error&nbsp;variance).<br>
	    
	    If this ratio is too large then the observation is 
	    suspect and will be ignored.  If this value is larger than the 
	    corresponding one in the filter, then it does nothing; that obs 
	    has already been excluded by the filter. A histogram of the values of
	    the distance ratio is saved in <em class="file">nsigma.dat</em><BR>
            Default: 3.0</TD></TR>  

<TR><!--contents--><TD valign=top>   input_qc_threshold </TD>
    <!--  type  --><TD valign=top>   real         </TD>
    <!--descript--><TD>Observations with quality control values greater than this
	    will be excluded from the diagnostics.<BR>
            Default: 4.0</TD></TR>  

<TR><!--contents--><TD valign=top>   Nregions   </TD>
    <!--  type  --><TD valign=top>   integer    </TD>
    <!--descript--><TD>Number of regions of the globe for which you'd like
	    obs space diagnostics.<BR>
	    Default: 4</TD></TR>  

<TR><!--contents--><TD valign=top>   lonlim1    </TD>
    <!--  type  --><TD valign=top>   real       </TD>
    <!--descript--><TD>Westernmost longitudes of the regions.<BR>
	    Default: 0.0, 0.0, 0.0, 235.0</TD></TR>  

<TR><!--contents--><TD valign=top>   lonlim2    </TD>
    <!--  type  --><TD valign=top>   real       </TD>
    <!--descript--><TD>Easternmost longitudes of the regions.<BR>
	    Default: 360.0, 360.0, 360.0, 295.0</TD></TR>  

<TR><!--contents--><TD valign=top>   latlim1    </TD>
    <!--  type  --><TD valign=top>   real       </TD>
    <!--descript--><TD>Southernmost latitudes of the regions.<BR>
	    Default: 20.0, -80.0, -20.0, 25.0</TD></TR>  

<TR><!--contents--><TD valign=top>   latlim2    </TD>
    <!--  type  --><TD valign=top>   real       </TD>
    <!--descript--><TD>Northernmost latitudes of the regions.<BR>
	    Default: 80.0, -20.0, 20.0, 55.0</TD></TR>  

<TR><!--contents--><TD valign=top>   reg_names  </TD>
    <!--  type  --><TD valign=top>   character  </TD>
    <!--descript--><TD>Array of names of the regions to be analyzed.<BR>
	    Default: 'Northern&nbsp;Hemisphere','Southern&nbsp;Hemisphere',
	    'Tropics','North&nbsp;America'</TD></TR>  

<TR><!--contents--><TD valign=top>   print_mismatched_locs </TD>
    <!--  type  --><TD valign=top>   logical               </TD>
    <!--descript--><TD>Print instances where U and V "pairs" don't have the 
	    same location.<BR>
	    Default: .false. </TD></TR>  

<TR><!--contents--><TD valign=top>   print_obs_locations </TD>
    <!--  type  --><TD valign=top>   logical             </TD>
    <!--descript--><TD>Create additional output files with the lat/lon
            location of each observation plus obs type.<BR>
	    Default: .false. </TD></TR>  

<TR><!--contents--><TD valign=top>   verbose   </TD>
    <!--  type  --><TD valign=top>   logical   </TD>
    <!--descript--><TD>Print extra info about the obs_diag run.<BR>
            Default: .false. </TD></TR>  

</TABLE>

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<BR><HR><BR>
<H2>FILES</H2>
<UL><LI>output observation space diagnostic file from 
	filter_nml;obs_sequence_out_name</LI>
    <LI>model initial file</LI>
    <LI>obs_diag_nml in <em class="file">input.nml</em></LI>
    <LI>Matlab&#174; input files; OBS_TYPE_VARIABLE_diagnostic.dat</LI>
    <LI><em class="file">dart_log.out</em> list directed output 
        from the obs_diag.</LI>
    <LI><em class="file">nsigma.dat</em> contains the distance ratio 
	histogram -- useful for estimating rat_cri.</LI>
</UL>

<!--==================================================================-->
<!-- Discuss  typical usage of obs_diag.                              -->
<!--==================================================================-->

<H3 class=indent1>Discussion</H3>
<A NAME="Usage"></A>
<BR><HR><BR>
<H2>USAGE</H2>

<P>
Obs_diag is built in .../DART/models/your_model/work, in the same way
as the other DART components.
</P>

<P>
Obs_diag assumes an organization of the assimilation output which has been
found to be clear and useful&nbsp;;^)
<BR><BR>
All the output to be saved is moved from the
directory where the assimilation occurs to an Experiment directory (named by you).  
Experiment should be populated with subdirectories - one for each obs_seq.out(input!) 
file of the assimilation - containing observation space output files, 
typically "obs_seq.final".
Obs_diag assumes the names of the subdirectories where the obs_seq.final 
files are found are of the form  mm_##.
At one point, the first 2 characters of the subdirectory names referred to 'month'.
This number will be read from the obs_seq_nml variable first_bin_center(2).  
The second pair of digits ## define sequentially numbered directories,
corresponding to the obs_seq.out files used to run the filter. 
The ##s that are used will be determined based on the time span specified in 
obs_seq_nml and the available obs_seq.final files.
Obs_diag searches in these subdirectories for the obs_seq.final files  
which contain dates and times corresponding to those specified in its namelist.  
For obs_seq.final file numbers &#60; 10 the subdirectory name will be padded with
a 0, to make it a 2 character number.
The Iceland version of obs_diag won't handle ## &#62; 99.
</P>

<P>
Obs_diag may require a model input file from which to get grid information, 
metadata, and links to modules providing the models expected observations.
</P>
<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR><BR>
<H2>REFERENCES</H2>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>obs_diag</TD>
    <!-- message --><TD VALIGN=top>No first observation  in sequence.</TD>
    <!-- comment --><TD VALIGN=top>get_first_obs couldn't find a "first obs" 
                                   in the obs_seq.final. </TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>obs_diag</TD>
    <!-- message --><TD VALIGN=top>No last observation in sequence</TD>
    <!-- comment --><TD VALIGN=top>get_last_obs couldn't find a "last obs" 
                                   in the obs_seq.final </TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>obs_diag</TD>
    <!-- message --><TD VALIGN=top>metadata incomplete</TD>
    <!-- comment --><TD VALIGN=top>Couldn't find the indices on the obs_seq.final file
                                   of the Posterior/Prior mean/spread, or the obs index"</TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>filter_get_obs_info</TD>
    <!-- message --><TD VALIGN=top>Vertical coordinate not recognized</TD>
    <!-- comment --><TD VALIGN=top>It must be "surface", "pressure", or "height"</TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>Convert2Time</TD>
    <!-- message --><TD VALIGN=top>namelist parameter out-of-bounds. Fix and try again</TD>
    <!-- comment --><TD VALIGN=top>bin_width, bin_separation, and time_to_skip must have 
                                   year = 0 and month = 0</TD>
</TR>

</TABLE>
</div>

<A NAME="PrivateComponents"></A>
<BR><HR><BR>
<H2>PRIVATE COMPONENTS</H2>
<!--==================================================================-->
<!-- Internal subroutines and functions.                              -->
<!--==================================================================-->
<!-- Tim ...? -->


<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->
<A NAME="KnownBugs"></A>
<BR><HR><BR>
<H2>KNOWN BUGS</H2>
<P>
none at this time
</P>

<!--==================================================================-->
<!-- Descibe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR><BR>
<H2>FUTURE PLANS</H2>
<P>
Make subdirectory names (containing obs_seq.final files) into simple sequential
numbers, independent of months, days, etc.<BR>
What about no_vert vertical coordinate variables?<BR>
Remove the need for max_num_bins<BR>
</P>

<!--==================================================================-->

<HR>
</BODY>
</HTML>
