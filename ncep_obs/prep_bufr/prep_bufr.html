<HTML>
<HEAD>
<TITLE>program prepbufr</TITLE>
<link rel="stylesheet" type="text/css" href="../../doc/html/doc.css"></link>
</HEAD>
<BODY>
<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<DIV ALIGN=CENTER>
<A HREF="#Instructions">INSTRUCTIONS</A> / 
<A HREF="#Namelist">NAMELIST</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A> /
</DIV>

<!--==================================================================-->

<H1>PROGRAM prepbufr</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
<TR><TD>Contact:       </TD><TD> Hui Liu </TD></TR>
<TR><TD>Revision:      </TD><TD> $Revision$ </TD></TR>
<TR><TD>Source:        </TD><TD> $URL$ </TD></TR>
<TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
<TR><TD>Change history:</TD><TD> try "svn log" or "svn diff" </TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>

<P>
   Translating NCEP BUFR files into DART obs_seq.out files (input file to filter)
   is a 2 stage process.  
   The first stage uses NCEP software to translate the BUFR file into an "intermediate"
   text file.  This is described in this document.
   The second step is to translate the intermediate files into obs_seq.out files, 
   which is done by create_real_obs, as described in 
   <A HREF="../create_real_obs.html" > create_real_obs </A>.
</P>

<P>
</P>

<!--==================================================================-->

<A NAME="Instructions"></A>
<BR><HR><BR>
<H2>INSTRUCTIONS</H2>

The prep_bufr package is free-standing and has not been completely assimilated 
into the DART architecture.  
It also requires adaptation of the sources codes and scripts to the computing
environment where it will be run.  It is not so robust that it can be controlled
just with input parameters.  It may not have the same levels of error detection and
warning that the rest of DART has, so the user should very careful about checking 
the end product for correctness.

<H3 class=indent1> Installation of the NCEP BUFR decoding program</H3>


This package is currently (as of release J) organized as .../DART/ncep_obs/prep_bufr/...:
<PRE>
src           Source code of the NCEP PREPBUFR decoder
lib           NCEP PREPBUFR library
convert_bufr  Source code (grabbufr) to convert the big endian PREPBUFR files to little
               endian files, and a script to compile the code.
install       A script to install the NCEP PREPBUFR decoder and the NCEP PREPBUFR library.
exe           Executables of the decoder and converter.
data          Where the NCEP PREPBUFR files (prepqm****) are loaded into from the NCAR Mass Store.
work          Where we run the script to do the decoding.
docs          Some background information about NCEP PREPBUFR observations.
</PRE>


<H4 class=indent1> Program /convert_bufr/grabbufr.f</H3>

<P>
The program grabbufr.f is used to convert the big endian format NCEP PREPBUFR
data into little endian format, when needed for use on the Intel&#174 processors. 
The grabbufr.f code is written in Fortran 90, and can be compiled with pgf90.
It has been compiled with gfortran&#174 on an Intel&#174 based Mac&#174.
</P>

<P>
This program reads the whole BUFR file into memory, and needs to know the size
of the file (in bytes).  
This information is obtained in the section "Use STAT function ..."
by uncommenting the statements 
<PRE>
c        do i = 1,size(JSTAT)
c           print*,'JSTAT(',i,') = ,'JSTAT(i)
c        enddo
c        EXIT(98)
</PRE>
the first time this program is run.
The file size (determined from ls -l) will match one of the elements of JSTAT.
That element should be assigned to KBYTES in the subsequent runs, which must have 
the JSTAT print out and STOP commented out again, and which actually convert the 
BUFR files.
</P>



<H4 class=indent1> The decoding program: /src/prepbufr.f</H3>

The program prepbufr.f is used to decode the NCEP reanalysis BUFR data into
intermediate text files. This program was originally developed by NCEP. 
It has been modified to output surface pressure, dry temperature, specific humidity, 
and wind components (U/V) of conventional radiosonde, aircraft reports, and satellite
cloud motion derived wind. 
There are additional observation types on the BUFR files, but using them they would 
require significant modifications of prepbufr and require detailed knowledge of the 
NCEP BUFR files.
The NCEP quality control indexes for these observations based on NCEP forecasts 
are also output and used in DART observation sequence files.
The NCEP PREPBUFR decoding program is written in Fortran 77 and
can be successfully compiled on
Linux computers using pgi90, f77 on SGI computers, and xlf on IBM SP systems.
an Intel&#174 based Mac&#174 with gfortran&#174.

<P>

If your operating system uses modules you may need to remove the default compiler
and add the one desired for this package.  For example
<UL>
    <LI> which pgf90 (to see if pgf90 is available.) </LI>
    <LI> module rm intel64 netcdf64 mpich64 </LI>
    <LI> module add pgi32 </LI>
</UL>
</P>

<P>
To compile the PREPBUFR libraries and the decoding program, go to the
install directory .../install.  Set the CPLAT variable in the install.sh to reflect
the correct platform.  CPLAT = linux is the default.
Execute the install.sh script to complete the compilations for the main
decoding program and the NCEP PREPBUFR library.
</P>

<P>
For platforms with little endian format, go to
/convert_bufr/ and run convert_bufr.csh to compile the converting code (grabbufr).
</P>

<P>
The executables (i.e., prepbufr.x, prepbufr_03Z.x and grabbufr.x) 
are placed in .../prep_bufr/exe. 
</P>

<P>
Platforms tested:

The code has been tested on NCAR systems: 
<UL><LI> Coral (Aspen Systems Linux cluster), </LI>
    <LI> Ocotillo.mmm (Linux), </LI>
    <LI> Tempest (SGI running IRIX), </LI>
    <LI> Bluesky (IBM Power4 cluster running AIX).</LI>
    </UL>
</P>

<H3 class=indent1> Getting the NCEP Reanalysis BUFR format data from NCAR MSS.  </H3>

<P>
The NCEP PREPBUFR files (prepqmYYMMDDHH) can be found within the NCEP reanalysis
dataset, ds090.0, on NCAR Mass Store System (MSS).
</P>

<P>
<!-- kdr; How would I launch another window for the data web site? 
          How to change bullets to '>' prompts for commands?        -->
To find the files:
<UL>
<LI>go to the <A HREF=http://dss.ucar.edu/pub/reanalysis/> NCAR/NCEP reanalysis archive.</A> </LI>
<LI>Click "Data Archive Summary" </LI>
<LI>Click "Complete Tar list of Table of Contents of All VSN's" </LI>
<LI>Look at the years you want and click on the ds090.0 next to the year mark.  </LI>
<LI>Find the data set you want by searching for prepqmYYMMDDHH, with YY, MM, DD, HH = 
    the year, month, day, and hour you want.  </LI>
</UL>
</P>

<P>
The prepqm file will be grouped with others in a weekly tar file. 
Each tar file has a unique file number like "A#####".
For example, for January of 2003, the 4 MSS TAR files are: A21899, A21900,
A21901, A21902. These are unblocked files.
The decoding program requires blocked version of the files. The corresponding
blocked files are A21899.blk, A21900.blk, A21901.blk, and A21902.blk.
These names don't appear in the web page, but are found on the mass store.
Each is about 400 Mb
</P>

<P>
From a machine with access to the MSS use
<UL><LI> msread -fbi filename.tar /DSS/A#####.blk </L> </UL>
where ##### is the data set number, to read the NCEP BUFR data tar files.
Put the filename.tar in subdirectory prep_bufr/data
<P>

<P>
Then
<UL><LI> tar -xvf filename.tar </L> </UL>
will yield individual 6-hourly NCEP PREPBUFR data files for the observations 
in the +/- 3-hours time window of 00Z,  06Z, 12Z, and 18Z of each day.
Note that DART obs_seq files are organized such that a 24 hour file with
4 observation times would contain observations from 3:01Z to 3:00Z of the
next day, centered on 6Z, 12Z, 18Z and "24Z".  
In addition, there are some observations at 3:00Z on the BUFR file labelled
with 06Z.
Then, in order to make a full day intermediate file incorporating all the
required obs from the "next" day, you'll need the BUFR files through 6Z
of the day after the last day of interest.
For example, to generate the observation sequence for Jan 1, 2003, the decoded
NCEP PREPBUFR text files for Jan 1 and 2, 2003 are needed, and hence the
BUFR files 
<UL> 
<LI> prepqm03010106 </LI>
<LI> prepqm03010112 </LI>
<LI> prepqm03010118 </LI>
and 
<LI> prepqm03010200 </LI>
<LI> prepqm03010206 </LI>
</UL>
are needed.
</P>

<H3 class=indent1> Running the NCEP BUFR decoding program</H3>

<P>
In prep_bufr/work/prepbufr.csh set the appropriate values of the year, month, first day, 
and last day of the period you desire, and the variable "convert" to control conversion
from big- to little-endian.  
Confirm that the raw BUFR files are in ../data, or that prepbufr.csh has been changed to
find them.
Execute prepbufr.csh in the work directory.
It has code for running in the LSF batch environment, but not PBS.
</P>

<P>
Currently, the script generates daily decoded PREPBUFR text data which contains the
observations within the time window of 3:01Z of the day to 3:00Z of next day.
These daily output text files are named as temp_obs.yyyymmdd.  
These text PREPBUFR data files can then be read by
DART/ncep_obs/<A HREF="../create_real_obs.html" > create_real_obs </A>.
to generate the DART daily observation
sequence files.
</P>




<!--==================================================================-->

<A NAME="OTHER MODULES USED"></A>
<BR><HR><BR>
<H2>OTHER MODULES USED</H2>
<!--
<PRE>
types_mod
obs_sequence_mod
real_obs_mod
utilities_mod
</PRE>
-->


<!--==================================================================-->
<!--=================== DESCRIPTION OF A NAMELIST  ===================-->

<A NAME="Namelist"></A>
<BR><HR><BR>
<H2>INCLUDE file </H2>
<P>
The prepbufr package doesn't use any namelists, but
prepbufr.prm contains some parameters, while 
other parameters are set in .../prep_bufr/work/prepbufr.csh

<!-- <div class=namelist><pre>
<em class=call>namelist /    / </em> &
</pre></div>

<H3 class=indent1>Discussion</H3>


<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<BR><HR><BR>
<H2>FILES</H2>
<UL><LI>input file(s); NCEP BUFR  observation files named using ObsBase 
        with the  "yymmddhh" date tag on the end.  Input to grabbufr if big- to 
        little-endian is to be done.  Input to prepbufr if not.
    <LI>intermediate (binary) prepqm.little; output from grabbufr, 
	input to prepbufr.
    <LI>intermediate (text) file(s) "temp_obs.yyyymmdd"; output from prepbufr,
	input to create_real_obs
</UL>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR><BR>
<H2>REFERENCES</H2>
.../DART/ncep_obs/prep_bufr/docs/*  (NCEP text files describing the BUFR files)

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<BR><HR><BR>
<H2>KNOWN BUGS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Descibe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR><BR>
<H2>FUTURE PLANS</H2>
<P>
Further development to get observations directly from original <BR>
(undecoded) NCEP BUFR files.
</P>


<HR>
</BODY>
</HTML>
