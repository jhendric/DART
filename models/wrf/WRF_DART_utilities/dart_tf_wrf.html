<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<HTML>
<TITLE>program dart_tf_wrf</TITLE>
<link rel=stylesheet type=text/css href=../doc/html/doc.css>
<BODY>

<DIV ALIGN=CENTER>
<A HREF="#Modules">MODULES</A> / 
<A HREF="#Namelist">NAMELIST</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A>
<A HREF="#PrivateComponents">PRIVATE COMPONENTS</A>
</DIV>

<!--==================================================================-->

<H1>PROGRAM dart_tf_wrf</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
   <TR><TD>Contact:       </TD><TD> Tim Hoar                     </TD></TR>
   <TR><TD>Reviewers:     </TD><TD> &nbsp;                       </TD></TR>
   <TR><TD>Revision:      </TD><TD> $Revision$             </TD></TR>
   <TR><TD>Release Name:  </TD><TD> $Name$                    </TD></TR>
   <TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
   <TR><TD>Change history:</TD><TD> see CVS log </TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>

<P>
   Program to convert WRF netCDF input files into DART format, and vice versa.
</P>

<!--==================================================================-->

<A NAME="Modules"></A>
<BR><HR><BR>
<H2>MODULES DIRECTLY USED</H2>
<PRE>
types_mod
time_manager_mod
utilities_mod
models/wrf/WRF_DART_utilities/wrf_data_module
assim_model_mod
</PRE>

<H2>MODULES INDIRECTLY USED</H2>
<PRE>
models/wrf/model_mod
models/wrf/module_map_utils
obs_kind_mod
location/threed_sphere/location_mod
random_seq_mod
random_nr_mod
</PRE>

<!--==================================================================-->
<!--=================== DESCRIPTION OF A NAMELIST  ===================-->

<A NAME="Namelist"></A>
<BR><HR><BR>
<H2>NAMELIST</H2>
<P>We adhere to the F90 standard of starting a namelist with an ampersand 
'&#38;' and terminating with a slash '/'.
<div class=namelist>
<pre>
<em class=call>namelist / model_nml / </em> &#38;
    output_state_vector, num_moist_vars, num_domains, calendar_type, surf_obs,
    h_diab, adv_mod_command
</pre>
</div>
</P>

<H3 class=indent1>Discussion</H3>

<P>The program uses the model_nml. See the description in <em
class=file>model_mod.html</em>
</P>

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<BR><HR><BR>
<H2>FILES</H2>
<UL>
   <LI>input namelist ; <em class=file>input.nml</em>
   <LI>Input - output WRF state netCDF files; <em class=file>wrfinput_d01,
   wrfinput_d02, ...</em>
   <LI>Input - output dart state vector format files ; <em
   class=file>dart_wrf_vector</em>
   <LI>Input - output: <em class=file>wrf.info</em>
</UL>

<H3>File formats</H3>

<P>In the conversion from dart to WRF, the <em class=file>dart_wrf_vector</em>
file is usually one of the <em class=file>assim_model_state_ic#</em> that the
filter writes out to advance the ensemble. As input, the dart_wrf_vector
includes the target time in addition to the valid time at the beginning of the
file. As output, the dart_wrf_vector includes only the valid time at the
beginning of the file and is usually renamed as <em
class=file>assim_model_state_ud#</em> as input to the filter for the next
assimilation cycle.
</P>

<P>The file <em class=file>wrf.info</em> contains the target dart time, the valid
dart time, the valid date, the number of domains, and the command used to
executed the WRF model. The file <em class=file>wrf.info</em> is created in the
conversion from dart to WRF. In the conversion from WRF back to dart, the
target time is read from the file <em class=file>wrf.info</em>, which should
then be the valid time. This will be the time written to the dart vector
file. The rest of the information in the file <em class=file>wrf.info</em> is
only used by the program ensemble_init and by the script advance_model.csh.

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR><BR>
<H2>REFERENCES</H2>
<UL>
</UL>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>dart_open_and_alloc, transfer_dart_wrf</TD>
    <!-- message --><TD VALIGN=top>n_moist = is too large.</TD>
    <!-- comment --><TD VALIGN=top>The maximum number of moist variables is
    7. In order, they are [qv, qc, qr, qi, qs, qg, qnice]</TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>transfer_dart_wrf</TD>
    <!-- message --><TD VALIGN=top>n_values differ in transfer</TD>
    <!-- comment --><TD VALIGN=top>If you get to this point, there would an
    inconsistency between subroutines dart_open_and_alloc and transfer_dart_wrf.</TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>trans_2d</TD>
    <!-- message --><TD VALIGN=top>nx, ny, not compatible</TD>
    <!-- comment --><TD VALIGN=top>Dimensions nx, ny incompatible with incoming
    array a2d.</TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>trans_3d</TD>
    <!-- message --><TD VALIGN=top>nx, ny, nz, not compatible</TD>
    <!-- comment --><TD VALIGN=top>Dimensions nx, ny, nz incompatible with incoming
    array a3d.</TD>
</TR>

</TABLE>
</div>

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<BR><HR><BR>
<H2>KNOWN BUGS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Describe Future Plans.                                           -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR><BR>
<H2>FUTURE PLANS</H2>
<P>
<LI>This program has to be updated when new prognostic variables are included
in the state vector, e.g. when tracers or chemical species are evolved
in WRF. The program will also need to be updated to add parameters to be estimated.
</P>

<!--==================================================================-->
<!-- Declare all private entities.                                    -->
<!--==================================================================-->

<A NAME="PrivateComponents"></A>
<BR><HR><BR>
<H2>PRIVATE COMPONENTS</H2>

<!--=================== DESCRIPTION OF SUBROUTINE ====================-->

<P></P><HR><P></P>
<div class=routine>
<em class=call> call dart_open_and_alloc( wrf, dart, n_values, dart_unit,
dart_to_wrf, debug )</em>
<pre>
integer,          intent(out) :: <em class=code> dart_unit </em>
logical,          intent(in)  :: <em class=code> dart_to_wrf, debug </em>
type(wrf_dom),    intent(in)  :: <em class=code> wrf </em>
real(r8),         pointer     :: <em class=code> dart(:) </em>
integer,          intent(out) :: <em class=code> n_values  </em>
</pre></div>

<H3 class=indent1>Description</H3>

<P>
Open a dart state vector file, determine the lenght of the dart
state vector, and allocate the dart state vector variable.
</P>

<!--=================== DESCRIPTION OF SUBROUTINE ====================-->

<P></P><HR><P></P>
<div class=routine>
<em class=call> call transfer_dart_wrf ( dart_to_wrf, dart, wrf, n_values_in)</em>
<pre>
logical,          intent(in) :: <em class=code> dart_to_wrf </em>
type(wrf_dom),    intent(in) :: <em class=code> wrf </em>
real(r8), pointer            :: <em class=code> dart(:) </em>
integer,          intent(in) :: <em class=code> n_values_in </em>
</pre></div>

<H3 class=indent1>Description</H3>

<P>
Transfert from dart state vector to a wrf structure, or vice versa.
</P>

<!--=================== DESCRIPTION OF SUBROUTINE ====================-->

<P></P><HR><P></P>
<div class=routine>
<em class=call> call trans_2d( one_to_two, a1d, a2d, nx, ny )</em>
<pre>
integer,  intent(in) :: <em class=code> nx,ny </em>
real(r8), intent(in) :: <em class=code> a1d(:) </em>
real(r8), intent(in) :: <em class=code> a2d(nx,ny) </em>
logical,  intent(in) :: <em class=code> one_to_two </em>
</pre></div>

<H3 class=indent1>Description</H3>

<P>
Transfert data from a 2D array into a 1D array, or vice versa.
</P>

<!--=================== DESCRIPTION OF SUBROUTINE ====================-->

<P></P><HR><P></P>
<div class=routine>
<em class=call> call trans_3d( one_to_three, a1d, a3d, nx, ny, nz )</em>
<pre>
integer,  intent(in) :: <em class=code> nx,ny,nz </em>
real(r8), intent(in) :: <em class=code> a1d(:) </em>
real(r8), intent(in) :: <em class=code> a3d(:,:,:) </em>
logical,  intent(in) :: <em class=code> one_to_three </em>
</pre></div>

<H3 class=indent1>Description</H3>

<P>
Transfert data from a 3D array into a 1D array, or vice versa.
</P>

<!--==================================================================-->

<HR>
</BODY>
</HTML>
