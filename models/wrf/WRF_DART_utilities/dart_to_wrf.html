<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
          "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
<HEAD>
<TITLE>program dart_to_wrf/wrf_to_dart</TITLE>
<link rel="stylesheet" type="text/css" href="../../../doc/html/doc.css">
</HEAD>
<BODY>
<A NAME="TOP"></A>

<center>
<A HREF="#Modules">MODULES</A> /
<A HREF="#Namelist">NAMELIST</A> /
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#FuturePlans">PLANS</A> /
<A HREF="#PrivateComponents">PRIVATE COMPONENTS</A> /
<A HREF="#Legalese">TERMS OF USE</A>
</center>

<H1>PROGRAM <em class=program>dart_to_wrf</em></H1>
<H1>PROGRAM <em class=program>wrf_to_dart</em></H1>
<P><small>Latest subversion revision tag:
<!-- version tag follows, do not edit -->$Id$
</small></P>

<P>
This document describes both programs that 
convert WRF netCDF input files into DART format, and vice versa.
<br />
<br />
For the sake of convenience, we will use <em class=file>wrfinput_d01</em>
to mean the WRF input file - no matter how many domains are used.
</P>
<P>
These programs are generally used in two different places during an assimilation.
One is explicitly by the user, or by a user-written script, to set up initial
condition files for DART, or to convert the final files from an assimilation
run into initial condition files for WRF to continue a free forecast run.
The other way is internally during the execution of an assimilation run,
when DART needs to execute WRF to advance the model state between
observation assimilation phases.  There are slight differences in the
requirements for the namelist settings between these two cases, which will
be described below.
</P>
<H2>The wrf_to_dart Program</H2>
<P>
The <em class=program>wrf_to_dart</em> program reads the <em class=code>&amp;model_nml</em>
namelist item <em class=code>wrf_state_variables</em> to determine which fields
in the WRF netCDF input file (typically <em class=file>wrfinput_d01</em>)
to read and put into the DART state vector.  The order of the fields
in the state vector is determined by the order the fields are listed in
the namelist, so they must remain consistent between running this utility
and executing an assimilation with DART.  The output filename is 
<em class=file>dart_wrf_vector</em>.  The file can be renamed afterwards
to be something like <em class=file>filter_ics</em> or 
<em class=file>filter_restart.####</em>.  Note that the input filename
for the filter program is a namelist setting in <em class=code>&amp;filter_nml</em>.  
Also note that the control of whether DART expects a single input file 
with all ensemble member data or a single file per ensemble member is
controlled by namelist settings in the <em class=code>&amp;ensemble_manager_nml</em>
namelist.  
For WRF it is more common to have a single file per ensemble member because of the
sizes of the files.
</P>
<P>
When explicitly called by the user, or by a user-written script, this
program is usually creating initial condition files for the start of
an assimilation run.
</P>
<P>
<em class=program>wrf_to_dart</em> is also called
by the <em class=file>advance_model.csh</em> script on files generated
by the <em class=program>filter</em> program, using filenames the user
typically does not see, e.g. <em class=file>assim_model_state_ud.####</em>,
where #### is the ensemble member number.  The script takes care of
renaming the output from <em class=program>wrf_to_dart</em> to be what filter expects to see.
If the assimilation is working, these files are usually removed by the
scripts and are transparent to the user.
</P>
<H2>The dart_to_wrf Program</H2>
<P>
The <em class=program>dart_to_wrf</em> program reads the <em class=code>&amp;model_nml</em>
namelist item <em class=code>wrf_state_variables</em> to determine which fields
are in the DART state vector so it can copy them to the right location 
in the WRF netCDF output file (typically <em class=file>wrfinput_d01</em>).
The order of the fields
in the state vector is determined by the order the fields are listed in
the namelist, so they must remain consistent between running this utility
and executing an assimilation with DART.  
Note that the WRF netCDF file contains much more information than is
in the DART state vector, so the file needs to be the correct one
for running WRF, having consistent data outside of the state variables.
</P>
<P>
<em class=program>dart_to_wrf</em> also has an additional namelist in 
the <em class=file>input.nml</em> file, 
<em class=code>&amp;dart_to_wrf_nml</em>.  The input filename is set there,
with a default of <em class=file>dart_wrf_vector</em>.  The output filename is
always <em class=file>wrfinput_d01</em> for a single domain.  If the DART
state vector contains multiple domains, files <em class=file>wrfinput_d02, 
wrfinput_d03,</em> etc are opened and updated.  
</P>
<P>
To copy the data from a DART restart/output file into a WRF input file to start
a free forecast run at the end of an assimilation, the namelist needs to be
set so <em class=code>model_advance_file</em> is .FALSE., which is not the
default, and the DART restart file can either be renamed to 'dart_wrf_vector'
or the input filename can be set in the namelist.  In this usage,
<em class=code>adv_mod_command</em> is unused.
</P>
<P>
During an assimilation when <em class=program>dart_to_wrf</em> is called
by the <em class=file>advance_model.csh</em> script 
the namelist values must have their original settings to function correctly.
This program is used to put the updated DART state information into the WRF
input file, and to set up the WRF namelists so the model runs for the correct
amount of time before the next assimilation cycle.
</P>

<!--==================================================================-->

<A NAME="Modules"></A>
<HR>
<H2>MODULES DIRECTLY USED</H2>
<PRE>
types_mod
time_manager_mod
utilities_mod
models/wrf/WRF_DART_utilities/wrf_data_module
assim_model_mod
</PRE>

<H2>MODULES INDIRECTLY USED</H2>
<PRE>
models/wrf/model_mod
models/wrf/module_map_utils
obs_kind_mod
location/threed_sphere/location_mod
random_seq_mod
random_nr_mod
</PRE>

<!--==================================================================-->
<!--=================== DESCRIPTION OF A NAMELIST  ===================-->
<!--==================================================================-->

<A NAME="Namelist"></A>
<HR>
<H2>NAMELIST</H2>
<P>We adhere to the F90 standard of starting a namelist with an ampersand
'&amp;' and terminating with a slash '/' for all our namelist input.
</P>
<div class=namelist>
<pre>
<em class=call>namelist / dart_to_wrf_nml / </em> &amp;
    model_advance_file, dart_restart_name, adv_mod_command

<em class=call>namelist / model_nml / </em> 

</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>The <em class=file>wrf_to_dart</em> program uses only the
WRF model namelist.  See the description in
the <a href="../model_mod.hmtl">WRF model_mod.html</a> file.
The <em class=program>dart_to_wrf</em> program uses the model namelist
plus an additional namelist: <em class=file>dart_to_wrf_nml</em>.
</P>

<P>Both namelists are read from a file 
called <em class=file>input.nml</em>
</P>

<TABLE border=0 cellpadding=3 width=100%>
<TR><TH align=left>Contents    </TH>
    <TH align=left>Type        </TH>
    <TH align=left>Description </TH></TR>
<TR><!--contents--><TD valign=top>model_advance_file  </TD>
    <!--  type  --><TD valign=top>logical             </TD>
    <!--descript--><TD>
     Set this to the default value of <b>.TRUE.</b> to work with
     the <em class=program>advance_model.csh</em> script during an
     assimilation run, where it converts the
     temporary/intermediary <em class=file>assim_model_state_ic</em> files. 
     <br />
     To insert the information from a DART restart/initial conditions 
     file into <em class=file>wrfinput_d01</em> set this to
     <b>.FALSE.</b> (i.e. for a free run of WRF).
     <br />
     The <em class=program>dart_to_wrf</em> program is able to convert
     both types of DART restart files: those with two timestamp records 
     followed by the model state, and those with a single timestamp record 
     followed by the model state (the type most commonly encountered if the 
     assimilation is successful). 
     Default .TRUE. </TD></TR>
<TR><!--contents--><TD valign=top>dart_restart_name    </TD>
    <!--  type  --><TD valign=top>character(len=128)   </TD>
    <!--descript--><TD>
     Set this to the default value of <b>'dart_wrf_vector'</b> to
     work with the <em class=program>advance_model.csh</em> script.
     To read the input information from a DART restart file with
     a different name, set this to another value, e.g. 'filter_ics'.
     Remember to change <em class=code>model_advance_file</em> to 
     <em class=code>.FALSE.</em> if the input file is a DART
     restart or initial conditions file.
     Default 'dart_wrf_vector'. </TD></TR>
<TR><!--contents--><TD valign=top>adv_mod_command      </TD>
    <!--  type  --><TD valign=top>character(len=128)   </TD>
    <!--descript--><TD>
     Set this to the default value of <b>'./wrf.exe'</b> to work
     with the <em class=program>advance_model.csh</em>  script.
     This value is ignored if <em class=code>model_advance_file</em>
     is .FALSE., but if it is .TRUE. then this string along with
     the necessary time information is written into 
     a file called 'wrf.info'.
     Default './wrf.exe'. This value used to be set in the
     WRF &amp;model_mod namelist, but has moved to here.</TD></TR>
</TABLE>


</div>
<br>

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<HR>
<H2>FILES</H2>
<UL>
   <LI>input namelist : <em class=file>input.nml</em></LI>
   <LI>Input - output WRF state netCDF files : <em class=file>wrfinput_d01,
   wrfinput_d02, ...</em></LI>
   <LI>Input - output DART state vector format files : 
   <em class=file>dart_wrf_vector</em></LI>
   <LI>Input - output: <em class=file>wrf.info</em></LI>
</UL>

<H3>File formats</H3>

<P>During the model advances within an assimilation run,
in the conversion from DART to WRF, the <em class=file>dart_wrf_vector</em>
file is usually one of the <em class=file>assim_model_state_ic#</em> that the
filter writes out to advance the ensemble. As input, the dart_wrf_vector
includes the target time in addition to the valid time at the beginning of the
file. As output, the dart_wrf_vector includes only the valid time at the
beginning of the file and is usually renamed as <em
class=file>assim_model_state_ud#</em> as input to the filter for the next
assimilation cycle.
</P>

<P>The file <em class=file>wrf.info</em> contains the target DART time, the valid
DART time, the valid date, the number of domains, and the command used to
executed the WRF model. The file <em class=file>wrf.info</em> is created in the
conversion from DART to WRF. In the conversion from WRF back to DART, the
target time is read from the file <em class=file>wrf.info</em>, which should
then be the valid time. This will be the time written to the DART vector
file. The rest of the information in the file <em class=file>wrf.info</em> is
only used by the program ensemble_init and by the script advance_model.csh.
</P>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<HR>
<H2>REFERENCES</H2>
<ul>
<li> none </li>
</ul>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class=errors>
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>trans_2d</TD>
    <!-- message --><TD VALIGN=top>nx, ny, not compatible</TD>
    <!-- comment --><TD VALIGN=top>Dimensions nx, ny incompatible with incoming
    array a2d.</TD></TR>

<TR><!-- routine --><TD VALIGN=top>trans_3d</TD>
    <!-- message --><TD VALIGN=top>nx, ny, nz, not compatible</TD>
    <!-- comment --><TD VALIGN=top>Dimensions nx, ny, nz incompatible with incoming
    array a3d.</TD></TR>

</TABLE>
</div>

<H2>KNOWN BUGS</H2>
<P>
none
</P>

<!--==================================================================-->
<!-- Describe Future Plans.                                           -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<HR>
<H2>FUTURE PLANS</H2>
<P>
none.
</P>

<!--==================================================================-->
<!-- PrivateComponents                                                -->
<!--==================================================================-->

<A NAME="PrivateComponents"></A>
<HR>
<H2>PRIVATE COMPONENTS</H2>

<br>

<!--==================================================================-->
<!-- Legalese & Metadata                                              -->
<!--==================================================================-->

<A NAME="Legalese"></A>
<HR>
<H2>Terms of Use</H2>

<P>
DART software - Copyright &copy; 2004 - 2010 UCAR.<br>
This open source software is provided by UCAR, "as is",<br>
without charge, subject to all terms of use at<br>
<a href="http://www.image.ucar.edu/DAReS/DART/DART_download">
http://www.image.ucar.edu/DAReS/DART/DART_download</a>
</P>

<TABLE border=0 cellpadding=0 width=100% summary="">
<TR><TD valign=top>Contact:       </TD><TD> Hui Liu, David Dowell </TD></TR>
<TR><TD valign=top>Revision:      </TD><TD> $Revision$ </TD></TR>
<TR><TD valign=top>Source:        </TD><TD> $URL$ </TD></TR>
<TR><TD valign=top>Change Date:   </TD><TD> $Date$ </TD></TR>
<TR><TD valign=top>Change&nbsp;history:&nbsp;</TD><TD> try "svn&nbsp;log" or "svn&nbsp;diff" </TD></TR>
</TABLE>

<!--==================================================================-->

</BODY>
</HTML>
