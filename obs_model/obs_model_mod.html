<HTML>
<HEAD>
<TITLE>module obs_model_mod</TITLE>
<link rel="stylesheet" type="text/css" href="../doc/html/doc.css"></link> 
</HEAD>
<BODY>
<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<DIV ALIGN=CENTER>
<A HREF="#Interface">INTERFACE</A> / 
<A HREF="#PublicEntities">PUBLIC COMPONENTS</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A> /
</DIV>

<!--==================================================================-->

<H1>MODULE obs_model_mod</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
<TR><TD>Contact:       </TD><TD> Jeff Anderson     </TD></TR>
<TR><TD>Revision:      </TD><TD> $Revision$ </TD></TR>
<TR><TD>Source:        </TD><TD> $URL$ </TD></TR>
<TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
<TR><TD>Change history:</TD><TD> try "svn log" or "svn diff" </TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>

<P>
   This is the highest level in DART where a module has access to details of 
both the assim_model structure and the observation structure. Operations like
the evaluation of forward operators that require a knowledge of both the 
observations and the model details are computed here.
</P>
<P>
</P>

<!--==================================================================-->

<A NAME="OTHER MODULES USED"></A>
<BR><HR><BR>
<H2>OTHER MODULES USED</H2>
<PRE>
types_mod
utilities_mod
assim_model_mod
obs_sequence_mod
obs_def_mod
time_manager_mod
ensemble_manager_mod
mpi_utilities_mod
</PRE>

<!--==================================================================-->
<!--Note to authors. The first row of the table is different.         -->

<A NAME="Interface"></A>
<BR><HR><BR>
<H2>PUBLIC INTERFACE</H2>

<TABLE>
<TR><TD><em class=call>use obs_model_mod, only : </em></TD>
                   <TD><A HREF="#advance_state">advance_state</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#move_ahead">move_ahead</A></TD></TR>
</TABLE>

<H3 class=indent1>NOTES</H3>

<!--==================================================================-->
<!-- Declare all public entities ...                                  -->
<!-- duplicate public routines template as many times as necessary    -->
<!-- make sure you replace all yyyroutine?? strings                   -->
<!--==================================================================-->

<A NAME="PublicEntities"></A>
<BR><HR><BR>
<H2>PUBLIC COMPONENTS</H2>
<BR>



<!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="move_ahead"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call move_ahead(ens_handle, ens_size, seq, 
     last_key_used, key_bounds, num_obs_in_set, async, adv_ens_command) </em>
 <pre>
 type(ensemble_type),     intent(in)  :: <em class=code>ens_handle</em>
 integer,                 intent(in)  :: <em class=code>ens_size</em>
 type(obs_sequence_type), intent(in)  :: <em class=code>seq</em>
 integer,                 intent(in)  :: <em class=code>last_key_used</em>
 integer, dimension(2),   intent(out) :: <em class=code>key_bounds</em>
 integer,                 intent(out) :: <em class=code>num_obs_in_set</em>
 integer,                 intent(in)  :: <em class=code>async</em>
 character(len=*),        intent(in)  :: <em class=code>adv_ens_command</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Given an observation sequence and an ensemble, determines how to advance the
model so that the next set of observations can be assimilated. Also returns
the first and last keys and the number of observations to be assimilated at
this time. The algorithm implemented here (one might want to have other
variants) first finds the time of the next observation that has not been
assimilated at a previous time. It also determines the time of the ensemble
state vectors. It then uses information about the model's time stepping 
capabilities to determine the time to which the model can be advanced that
is CLOSEST to the time of the next observation. For now, this algorithm assumes
that the model's timestep is a constant. A window of width equal to the model
timestep is centered around the closest model time to the next observation
and all observations in this window are added to the set to be assimilated.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>ens_handle&nbsp; &nbsp; </em></TD>
     <TD>Identifies the model state ensemble</TD></TR>
 <TR><TD valign=top><em class=code>ens_size&nbsp; &nbsp; </em></TD>
     <TD>Number of ensemble members</TD></TR>
 <TR><TD valign=top><em class=code>seq&nbsp; &nbsp; </em></TD>
     <TD>An observation sequence</TD></TR>
 <TR><TD valign=top><em class=code>last_key_used&nbsp; &nbsp; </em></TD>
     <TD>Identifies the last observation from the sequence that has 
         been used</TD></TR>
 <TR><TD valign=top><em class=code>key_bounds&nbsp; &nbsp; </em></TD>
     <TD>Returned lower and upper bound on observations to be used 
         at this time</TD></TR>
 <TR><TD valign=top><em class=code>num_obs_in_set&nbsp; &nbsp; </em></TD>
     <TD>Number of observations to be used at this time</TD></TR>
 <TR><TD valign=top><em class=code>async&nbsp; &nbsp; </em></TD>
     <TD>Controls how model is advanced (see filter and 
         advance_state() below.)</TD></TR>
 <TR><TD valign=top><em class=code>adv_ens_command&nbsp; &nbsp; </em></TD>
     <TD>Command issued by shell for async option 2 (see filter)</TD></TR>
 </TABLE>
 <BR>


 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="advance_state"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call advance_state(ens_handle, ens_size, target_time, 
                 async, adv_ens_command) </em>
 <pre>
 type(ensemble_type), intent(inout) :: <em class=code>ens_handle</em>
 integer, intent(in)                :: <em class=code>ens_size</em>
 type(time_type), intent(in)        :: <em class=code>target_time</em>
 integer, intent(in)                :: <em class=code>async</em>
 character(len=*), intent(in)       :: <em class=code>adv_ens_command</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Advances all ensemble size copies of an ensemble stored in ens_handle 
to the target_time. 
If async=0 this is done by repeated calls to 
the <tt>adv_1step()</tt> subroutine. 
If async=2, a call to the shell with the 
command <em class=code>adv_ens_command</em> is used.
If async=4, the filter program synchronizes with the MPI job shell script
using the <tt>block_task()</tt> and <tt>restart_task()</tt> routines
to suspect execution until all model advances have completed.
The script can start the model advances using MPI and have it execute
in parallel in this mode.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>ens_handle&nbsp; &nbsp; </em></TD>
     <TD>Structure for holding ensemble information and data</TD></TR>
 <TR><TD valign=top><em class=code>ens_size&nbsp; &nbsp; </em></TD>
     <TD>Ensemble size.</TD></TR>
 <TR><TD valign=top><em class=code>target_time&nbsp; &nbsp; </em></TD>
     <TD>Time to which model is to be advanced.</TD></TR>
 <TR><TD valign=top><em class=code>async&nbsp; &nbsp; </em></TD>
     <TD>How to advance model: 
          <TABLE width=100% border=0 summary="" celpadding=3>
           <TR><TD>0 = subroutine adv_1step</TD></TR>
           <TR><TD>2 = shell executes adv_ens_command</TD></TR>
           <TR><TD>4 = MPI job script advances models and 
                      syncs with filter task</TD></TR>
          </TABLE> </TD></TR>
 <TR><TD valign=top><em class=code>adv_ens_command&nbsp; &nbsp; </em></TD>
     <TD>Command to be issued to shell to advance model if async=2.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<BR><HR><BR>
<H2>FILES</H2>
<UL><LI>assim_model_state_ic#####<BR>
<LI> assim_model_state_ud#####<BR>
<LI> filter_control#####
</UL>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR><BR>
<H2>REFERENCES</H2>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>move_ahead</TD>
    <!-- message --><TD VALIGN=top>next obs time not in model time window</TD>
    <!-- comment --><TD VALIGN=top>Error in algorithm to compute observation window</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>advance_state</TD>
    <!-- message --><TD VALIGN=top>target time ###,### is before model_time ###,### </TD>
    <!-- comment --><TD VALIGN=top>Target time must not be before current model time.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>advance_state</TD>
    <!-- message --><TD VALIGN=top>Trying to use ### model states -- too many.
            Use less than 10000 member ensemble.</TD>
    <!-- comment --><TD VALIGN=top>Maximum of 9999 ensemble members is allowed.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>advance_state</TD>
    <!-- message --><TD VALIGN=top>Can only have 10000 processes.</TD>
    <!-- comment --><TD VALIGN=top> No more than 9999 processes can run.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>advance_state</TD>
    <!-- message --><TD VALIGN=top>input.nml - async is #, must be 0, or 2.</TD>
    <!-- comment --><TD VALIGN=top>Only 0 or 2 work for async.</TD>
</TR>
</TABLE>
</div>

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<BR><HR><BR>
<H2>KNOWN BUGS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Describe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR><BR>
<H2>FUTURE PLANS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Have not fleshed out this part yet ... ha ha ha                  -->
<!--==================================================================-->

<HR>
</BODY>
</HTML>
