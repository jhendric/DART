<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<HTML>
<TITLE>module obs_model_mod</TITLE>
<link rel=stylesheet type=text/css href=../doc/html/doc.css>
<BODY>

<DIV ALIGN=CENTER>
<A HREF="#Interface">INTERFACE</A> / 
<A HREF="#PublicEntities">PUBLIC COMPONENTS</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A> /
</DIV>

<!--==================================================================-->

<H1>MODULE obs_model_mod</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
   <TR><TD>Contact:       </TD><TD> Jeff Anderson                </TD></TR>
   <TR><TD>Reviewers:     </TD><TD> &nbsp;                       </TD></TR>
   <TR><TD>Revision:      </TD><TD> $Revision$             </TD></TR>
   <TR><TD>Release Name:  </TD><TD> $Name$                       </TD></TR>
   <TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
   <TR><TD>Change history:</TD><TD> see CVS log                  </TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>

<P>
   This is the highest level in DART where a module has access to details of 
both the assim_model structure and the observation structure. Operations like
the evaluation of forward operators that require a knowledge of both the 
observations and the model details are computed here.
</P>
<P>
</P>

<!--==================================================================-->

<A NAME="OTHER MODULES USED"></A>
<BR><HR><BR>
<H2>OTHER MODULES USED</H2>
<PRE>
types_mod
utilities_mod
location_mod (depends on model choice)
assim_model_mod
obs_sequence_mod
obs_def_mod
time_manager_mod
ensemble_manager_mod
</PRE>

<!--==================================================================-->
<!--Note to authors. The first row of the table is different.         -->

<A NAME="Interface"></A>
<BR><HR><BR>
<H2>PUBLIC INTERFACE</H2>

<TABLE>
<TR><TD><em class=call>use obs_model_mod, only : </em></TD>
                   <TD><A HREF="#get_close_states">get_close_states</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#move_ahead">move_ahead</A></TD></TR>
</TABLE>

<H3 class=indent1>NOTES</H3>

<!--==================================================================-->
<!-- Declare all public entities ...                                  -->
<!-- duplicate public routines template as many times as necessary    -->
<!-- make sure you replace all yyyroutine?? strings                   -->
<!--==================================================================-->

<A NAME="PublicEntities"></A>
<BR><HR><BR>
<H2>PUBLIC COMPONENTS</H2>
<BR>


<!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="get_close_states"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call get_close_states(seq, key, radius, numinds, indices, dist, x) </em>
 <pre>
 type(obs_sequence_type), intent(in) :: <em class=code>seq</em>
 integer, intent(in)                 :: <em class=code>key</em>
 real(r8), intent(in)                :: <em class=code>radius</em>
 integer, intent(out)                :: <em class=code>numinds</em>
 integer, dimension(:), intent(out)  :: <em class=code>indices</em>
 real(r8), dimension(:), intent(out) :: <em class=code>dist</em>
 real(r8), dimension(:), intent(in)  :: <em class=code>x</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Given an observation from an observation sequence, find the number
of state variables that are within distance 'radius' of the observation
location. Return the indices of the close states and the distances 
between each and the observation. The model state vector is, 
unfortunately, needed to compute locations of model state variables
in many complex models.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>seq&nbsp; &nbsp; </em></TD>
     <TD>An observation sequence</TD></TR>
 <TR><TD valign=top><em class=code>key&nbsp; &nbsp; </em></TD>
     <TD>Integer key identifying an observation in the sequence</TD></TR>
 <TR><TD valign=top><em class=code>radius&nbsp; &nbsp; </em></TD>
     <TD>Find close states within this radius</TD></TR>
 <TR><TD valign=top><em class=code>numinds&nbsp; &nbsp; </em></TD>
     <TD>Number of close states found</TD></TR>
 <TR><TD valign=top><em class=code>indices&nbsp; &nbsp; </em></TD>
     <TD>Indices of the close state variables</TD></TR>
 <TR><TD valign=top><em class=code>dist&nbsp; &nbsp; </em></TD>
     <TD>The distance between each close state and the observation</TD></TR>
 <TR><TD valign=top><em class=code>x&nbsp; &nbsp; </em></TD>
     <TD>The model state vector, needed to compute distance in some models</TD></TR>
 </TABLE>
 <BR>

<!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="move_ahead"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call move_ahead(ens_handle, ens_size, model_size, seq, 
	 last_key_used, key_bounds, num_obs_in_set, async, adv_ens_command) </em>
 <pre>
 type(ensemble_type),     intent(in)  :: <em class=code>ens_handle</em>
 integer,                 intent(in)  :: <em class=code>ens_size</em>
 integer,                 intent(in)  :: <em class=code>model_size</em>
 type(obs_sequence_type), intent(in)  :: <em class=code>seq</em>
 integer,                 intent(in)  :: <em class=code>last_key_used</em>
 integer, dimension(2),   intent(out) :: <em class=code>key_bounds</em>
 integer,                 intent(out) :: <em class=code>num_obs_in_set</em>
 integer,                 intent(in)  :: <em class=code>async</em>
 character(len=129),      intent(in)  :: <em class=code>adv_ens_command</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Given an observation sequence and an ensemble, determines how to advance the
model so that the next set of observations can be assimilated. Also returns
the first and last keys and the number of observations to be assimilated at
this time. The algorithm implemented here (one might want to have other
variants) first finds the time of the next observation that has not been
assimilated at a previous time. It also determines the time of the ensemble
state vectors. It then uses information about the model's time stepping 
capabilities to determine the time to which the model can be advanced that
is CLOSEST to the time of the next observation. For now, this algorithm assumes
that the model's timestep is a constant. A window of width equal to the model
timestep is centered around the closest model time to the next observation
and all observations in this window are added to the set to be assimilated.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>ens_handle&nbsp; &nbsp; </em></TD>
     <TD>Identifies the model state ensemble</TD></TR>
 <TR><TD valign=top><em class=code>ens_size&nbsp; &nbsp; </em></TD>
     <TD>Number of ensemble members</TD></TR>
 <TR><TD valign=top><em class=code>model_size&nbsp; &nbsp; </em></TD>
     <TD>Size of model state vector</TD></TR>
 <TR><TD valign=top><em class=code>seq&nbsp; &nbsp; </em></TD>
     <TD>An observation sequence</TD></TR>
 <TR><TD valign=top><em class=code>last_key_used&nbsp; &nbsp; </em></TD>
     <TD>Identifies the last observation from the sequence that has been used</TD></TR>
 <TR><TD valign=top><em class=code>key_bounds&nbsp; &nbsp; </em></TD>
     <TD>Returned lower and upper bound on observations to be used at this time</TD></TR>
 <TR><TD valign=top><em class=code>num_obs_in_set&nbsp; &nbsp; </em></TD>
     <TD>Number of observations to be used at this time</TD></TR>
 <TR><TD valign=top><em class=code>async&nbsp; &nbsp; </em></TD>
     <TD>Controls how model is advanced (see filter)</TD></TR>
 <TR><TD valign=top><em class=code>adv_ens_command&nbsp; &nbsp; </em></TD>
     <TD>Command issued by shell for async option 2 (see filter)</TD></TR>
 </TABLE>
 <BR>

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<BR><HR><BR>
<H2>FILES</H2>
<UL><LI>NONE
</UL>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR><BR>
<H2>REFERENCES</H2>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>move_ahead</TD>
    <!-- message --><TD VALIGN=top>next obs time not in model time window</TD>
    <!-- comment --><TD VALIGN=top>Error in algorithm to compute observation window</TD>
</TR>
</TABLE>
</div>

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<BR><HR><BR>
<H2>KNOWN BUGS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Describe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR><BR>
<H2>FUTURE PLANS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Have not fleshed out this part yet ... ha ha ha                  -->
<!--==================================================================-->

<HR>
</BODY>
</HTML>
